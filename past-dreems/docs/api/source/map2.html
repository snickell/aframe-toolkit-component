<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>CodeRay output</title>
  <style type="text/css">
.CodeRay .line-numbers a {
  text-decoration: inherit;
  color: inherit;
}
body {
  background-color: white;
  padding: 0;
  margin: 0;
}
.CodeRay {
  background-color: hsl(0,0%,95%);
  border: 1px solid silver;
  color: black;
}
.CodeRay pre {
  margin: 0px;
}

span.CodeRay { white-space: pre; border: 0px; padding: 2px; }

table.CodeRay { border-collapse: collapse; width: 100%; padding: 2px; }
table.CodeRay td { padding: 2px 4px; vertical-align: top; }

.CodeRay .line-numbers {
  background-color: hsl(180,65%,90%);
  color: gray;
  text-align: right;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}
.CodeRay .line-numbers a {
  background-color: hsl(180,65%,90%) !important;
  color: gray !important;
  text-decoration: none !important;
}
.CodeRay .line-numbers pre {
  word-break: normal;
}
.CodeRay .line-numbers a:target { color: blue !important; }
.CodeRay .line-numbers .highlighted { color: red !important; }
.CodeRay .line-numbers .highlighted a { color: red !important; }
.CodeRay span.line-numbers { padding: 0px 4px; }
.CodeRay .line { display: block; float: left; width: 100%; }
.CodeRay .code { width: 100%; }

.CodeRay .debug { color: white !important; background: blue !important; }

.CodeRay .annotation { color:#007 }
.CodeRay .attribute-name { color:#b48 }
.CodeRay .attribute-value { color:#700 }
.CodeRay .binary { color:#549 }
.CodeRay .binary .char { color:#325 }
.CodeRay .binary .delimiter { color:#325 }
.CodeRay .char { color:#D20 }
.CodeRay .char .content { color:#D20 }
.CodeRay .char .delimiter { color:#710 }
.CodeRay .class { color:#B06; font-weight:bold }
.CodeRay .class-variable { color:#369 }
.CodeRay .color { color:#0A0 }
.CodeRay .comment { color:#777 }
.CodeRay .comment .char { color:#444 }
.CodeRay .comment .delimiter { color:#444 }
.CodeRay .constant { color:#036; font-weight:bold }
.CodeRay .decorator { color:#B0B }
.CodeRay .definition { color:#099; font-weight:bold }
.CodeRay .delimiter { color:black }
.CodeRay .directive { color:#088; font-weight:bold }
.CodeRay .docstring { color:#D42; }
.CodeRay .doctype { color:#34b }
.CodeRay .done { text-decoration: line-through; color: gray }
.CodeRay .entity { color:#800; font-weight:bold }
.CodeRay .error { color:#F00; background-color:#FAA }
.CodeRay .escape  { color:#666 }
.CodeRay .exception { color:#C00; font-weight:bold }
.CodeRay .float { color:#60E }
.CodeRay .function { color:#06B; font-weight:bold }
.CodeRay .function .delimiter { color:#024; font-weight:bold }
.CodeRay .global-variable { color:#d70 }
.CodeRay .hex { color:#02b }
.CodeRay .id  { color:#33D; font-weight:bold }
.CodeRay .include { color:#B44; font-weight:bold }
.CodeRay .inline { background-color: hsla(0,0%,0%,0.07); color: black }
.CodeRay .inline-delimiter { font-weight: bold; color: #666 }
.CodeRay .instance-variable { color:#33B }
.CodeRay .integer  { color:#00D }
.CodeRay .imaginary { color:#f00 }
.CodeRay .important { color:#D00 }
.CodeRay .key { color: #606 }
.CodeRay .key .char { color: #60f }
.CodeRay .key .delimiter { color: #404 }
.CodeRay .keyword { color:#080; font-weight:bold }
.CodeRay .label { color:#970; font-weight:bold }
.CodeRay .local-variable { color:#950 }
.CodeRay .map .content { color:#808 }
.CodeRay .map .delimiter { color:#40A}
.CodeRay .map { background-color:hsla(200,100%,50%,0.06); }
.CodeRay .namespace { color:#707; font-weight:bold }
.CodeRay .octal { color:#40E }
.CodeRay .operator { }
.CodeRay .predefined { color:#369; font-weight:bold }
.CodeRay .predefined-constant { color:#069 }
.CodeRay .predefined-type { color:#0a8; font-weight:bold }
.CodeRay .preprocessor { color:#579 }
.CodeRay .pseudo-class { color:#00C; font-weight:bold }
.CodeRay .regexp { background-color:hsla(300,100%,50%,0.06); }
.CodeRay .regexp .content { color:#808 }
.CodeRay .regexp .delimiter { color:#404 }
.CodeRay .regexp .modifier { color:#C2C }
.CodeRay .reserved { color:#080; font-weight:bold }
.CodeRay .shell { background-color:hsla(120,100%,50%,0.06); }
.CodeRay .shell .content { color:#2B2 }
.CodeRay .shell .delimiter { color:#161 }
.CodeRay .string { background-color:hsla(0,100%,50%,0.05); }
.CodeRay .string .char { color: #b0b }
.CodeRay .string .content { color: #D20 }
.CodeRay .string .delimiter { color: #710 }
.CodeRay .string .modifier { color: #E40 }
.CodeRay .symbol { color:#A60 }
.CodeRay .symbol .content { color:#A60 }
.CodeRay .symbol .delimiter { color:#740 }
.CodeRay .tag { color:#070; font-weight:bold }
.CodeRay .type { color:#339; font-weight:bold }
.CodeRay .value { color: #088 }
.CodeRay .variable { color:#037 }

.CodeRay .insert { background: hsla(120,100%,50%,0.12) }
.CodeRay .delete { background: hsla(0,100%,50%,0.12) }
.CodeRay .change { color: #bbf; background: #007 }
.CodeRay .head { color: #f8f; background: #505 }
.CodeRay .head .filename { color: white; }

.CodeRay .delete .eyecatcher { background-color: hsla(0,100%,50%,0.2); border: 1px solid hsla(0,100%,45%,0.5); margin: -1px; border-bottom: none; border-top-left-radius: 5px; border-top-right-radius: 5px; }
.CodeRay .insert .eyecatcher { background-color: hsla(120,100%,50%,0.2); border: 1px solid hsla(120,100%,25%,0.5); margin: -1px; border-top: none; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }

.CodeRay .insert .insert { color: #0c0; background:transparent; font-weight:bold }
.CodeRay .delete .delete { color: #c00; background:transparent; font-weight:bold }
.CodeRay .change .change { color: #88f }
.CodeRay .head .head { color: #f4f }

.CodeRay {
  border: none;
}
  </style>
</head>
<body>

<table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
<a href="#n15" name="n15">15</a>
<a href="#n16" name="n16">16</a>
<a href="#n17" name="n17">17</a>
<a href="#n18" name="n18">18</a>
<a href="#n19" name="n19">19</a>
<strong><a href="#n20" name="n20">20</a></strong>
<a href="#n21" name="n21">21</a>
<a href="#n22" name="n22">22</a>
<a href="#n23" name="n23">23</a>
<a href="#n24" name="n24">24</a>
<a href="#n25" name="n25">25</a>
<a href="#n26" name="n26">26</a>
<a href="#n27" name="n27">27</a>
<a href="#n28" name="n28">28</a>
<a href="#n29" name="n29">29</a>
<strong><a href="#n30" name="n30">30</a></strong>
<a href="#n31" name="n31">31</a>
<a href="#n32" name="n32">32</a>
<a href="#n33" name="n33">33</a>
<a href="#n34" name="n34">34</a>
<a href="#n35" name="n35">35</a>
<a href="#n36" name="n36">36</a>
<a href="#n37" name="n37">37</a>
<a href="#n38" name="n38">38</a>
<a href="#n39" name="n39">39</a>
<strong><a href="#n40" name="n40">40</a></strong>
<a href="#n41" name="n41">41</a>
<a href="#n42" name="n42">42</a>
<a href="#n43" name="n43">43</a>
<a href="#n44" name="n44">44</a>
<a href="#n45" name="n45">45</a>
<a href="#n46" name="n46">46</a>
<a href="#n47" name="n47">47</a>
<a href="#n48" name="n48">48</a>
<a href="#n49" name="n49">49</a>
<strong><a href="#n50" name="n50">50</a></strong>
<a href="#n51" name="n51">51</a>
<a href="#n52" name="n52">52</a>
<a href="#n53" name="n53">53</a>
<a href="#n54" name="n54">54</a>
<a href="#n55" name="n55">55</a>
<a href="#n56" name="n56">56</a>
<a href="#n57" name="n57">57</a>
<a href="#n58" name="n58">58</a>
<a href="#n59" name="n59">59</a>
<strong><a href="#n60" name="n60">60</a></strong>
<a href="#n61" name="n61">61</a>
<a href="#n62" name="n62">62</a>
<a href="#n63" name="n63">63</a>
<a href="#n64" name="n64">64</a>
<a href="#n65" name="n65">65</a>
<a href="#n66" name="n66">66</a>
<a href="#n67" name="n67">67</a>
<a href="#n68" name="n68">68</a>
<a href="#n69" name="n69">69</a>
<strong><a href="#n70" name="n70">70</a></strong>
<a href="#n71" name="n71">71</a>
<a href="#n72" name="n72">72</a>
<a href="#n73" name="n73">73</a>
<a href="#n74" name="n74">74</a>
<a href="#n75" name="n75">75</a>
<a href="#n76" name="n76">76</a>
<a href="#n77" name="n77">77</a>
<a href="#n78" name="n78">78</a>
<a href="#n79" name="n79">79</a>
<strong><a href="#n80" name="n80">80</a></strong>
<a href="#n81" name="n81">81</a>
<a href="#n82" name="n82">82</a>
<a href="#n83" name="n83">83</a>
<a href="#n84" name="n84">84</a>
<a href="#n85" name="n85">85</a>
<a href="#n86" name="n86">86</a>
<a href="#n87" name="n87">87</a>
<a href="#n88" name="n88">88</a>
<a href="#n89" name="n89">89</a>
<strong><a href="#n90" name="n90">90</a></strong>
<a href="#n91" name="n91">91</a>
<a href="#n92" name="n92">92</a>
<a href="#n93" name="n93">93</a>
<a href="#n94" name="n94">94</a>
<a href="#n95" name="n95">95</a>
<a href="#n96" name="n96">96</a>
<a href="#n97" name="n97">97</a>
<a href="#n98" name="n98">98</a>
<a href="#n99" name="n99">99</a>
<strong><a href="#n100" name="n100">100</a></strong>
<a href="#n101" name="n101">101</a>
<a href="#n102" name="n102">102</a>
<a href="#n103" name="n103">103</a>
<a href="#n104" name="n104">104</a>
<a href="#n105" name="n105">105</a>
<a href="#n106" name="n106">106</a>
<a href="#n107" name="n107">107</a>
<a href="#n108" name="n108">108</a>
<a href="#n109" name="n109">109</a>
<strong><a href="#n110" name="n110">110</a></strong>
<a href="#n111" name="n111">111</a>
<a href="#n112" name="n112">112</a>
<a href="#n113" name="n113">113</a>
<a href="#n114" name="n114">114</a>
<a href="#n115" name="n115">115</a>
<a href="#n116" name="n116">116</a>
<a href="#n117" name="n117">117</a>
<a href="#n118" name="n118">118</a>
<a href="#n119" name="n119">119</a>
<strong><a href="#n120" name="n120">120</a></strong>
<a href="#n121" name="n121">121</a>
<a href="#n122" name="n122">122</a>
<a href="#n123" name="n123">123</a>
<a href="#n124" name="n124">124</a>
<a href="#n125" name="n125">125</a>
<a href="#n126" name="n126">126</a>
<a href="#n127" name="n127">127</a>
<a href="#n128" name="n128">128</a>
<a href="#n129" name="n129">129</a>
<strong><a href="#n130" name="n130">130</a></strong>
<a href="#n131" name="n131">131</a>
<a href="#n132" name="n132">132</a>
<a href="#n133" name="n133">133</a>
<a href="#n134" name="n134">134</a>
<a href="#n135" name="n135">135</a>
<a href="#n136" name="n136">136</a>
<a href="#n137" name="n137">137</a>
<a href="#n138" name="n138">138</a>
<a href="#n139" name="n139">139</a>
<strong><a href="#n140" name="n140">140</a></strong>
<a href="#n141" name="n141">141</a>
<a href="#n142" name="n142">142</a>
<a href="#n143" name="n143">143</a>
<a href="#n144" name="n144">144</a>
<a href="#n145" name="n145">145</a>
<a href="#n146" name="n146">146</a>
<a href="#n147" name="n147">147</a>
<a href="#n148" name="n148">148</a>
<a href="#n149" name="n149">149</a>
<strong><a href="#n150" name="n150">150</a></strong>
<a href="#n151" name="n151">151</a>
<a href="#n152" name="n152">152</a>
<a href="#n153" name="n153">153</a>
<a href="#n154" name="n154">154</a>
<a href="#n155" name="n155">155</a>
<a href="#n156" name="n156">156</a>
<a href="#n157" name="n157">157</a>
<a href="#n158" name="n158">158</a>
<a href="#n159" name="n159">159</a>
<strong><a href="#n160" name="n160">160</a></strong>
<a href="#n161" name="n161">161</a>
<a href="#n162" name="n162">162</a>
<a href="#n163" name="n163">163</a>
<a href="#n164" name="n164">164</a>
<a href="#n165" name="n165">165</a>
<a href="#n166" name="n166">166</a>
<a href="#n167" name="n167">167</a>
<a href="#n168" name="n168">168</a>
<a href="#n169" name="n169">169</a>
<strong><a href="#n170" name="n170">170</a></strong>
<a href="#n171" name="n171">171</a>
<a href="#n172" name="n172">172</a>
<a href="#n173" name="n173">173</a>
<a href="#n174" name="n174">174</a>
<a href="#n175" name="n175">175</a>
<a href="#n176" name="n176">176</a>
<a href="#n177" name="n177">177</a>
<a href="#n178" name="n178">178</a>
<a href="#n179" name="n179">179</a>
<strong><a href="#n180" name="n180">180</a></strong>
<a href="#n181" name="n181">181</a>
<a href="#n182" name="n182">182</a>
<a href="#n183" name="n183">183</a>
<a href="#n184" name="n184">184</a>
<a href="#n185" name="n185">185</a>
<a href="#n186" name="n186">186</a>
<a href="#n187" name="n187">187</a>
<a href="#n188" name="n188">188</a>
<a href="#n189" name="n189">189</a>
<strong><a href="#n190" name="n190">190</a></strong>
<a href="#n191" name="n191">191</a>
<a href="#n192" name="n192">192</a>
<a href="#n193" name="n193">193</a>
<a href="#n194" name="n194">194</a>
<a href="#n195" name="n195">195</a>
<a href="#n196" name="n196">196</a>
<a href="#n197" name="n197">197</a>
<a href="#n198" name="n198">198</a>
<a href="#n199" name="n199">199</a>
<strong><a href="#n200" name="n200">200</a></strong>
<a href="#n201" name="n201">201</a>
<a href="#n202" name="n202">202</a>
<a href="#n203" name="n203">203</a>
<a href="#n204" name="n204">204</a>
<a href="#n205" name="n205">205</a>
<a href="#n206" name="n206">206</a>
<a href="#n207" name="n207">207</a>
<a href="#n208" name="n208">208</a>
<a href="#n209" name="n209">209</a>
<strong><a href="#n210" name="n210">210</a></strong>
<a href="#n211" name="n211">211</a>
<a href="#n212" name="n212">212</a>
<a href="#n213" name="n213">213</a>
<a href="#n214" name="n214">214</a>
<a href="#n215" name="n215">215</a>
<a href="#n216" name="n216">216</a>
<a href="#n217" name="n217">217</a>
<a href="#n218" name="n218">218</a>
<a href="#n219" name="n219">219</a>
<strong><a href="#n220" name="n220">220</a></strong>
<a href="#n221" name="n221">221</a>
<a href="#n222" name="n222">222</a>
<a href="#n223" name="n223">223</a>
<a href="#n224" name="n224">224</a>
<a href="#n225" name="n225">225</a>
<a href="#n226" name="n226">226</a>
<a href="#n227" name="n227">227</a>
<a href="#n228" name="n228">228</a>
<a href="#n229" name="n229">229</a>
<strong><a href="#n230" name="n230">230</a></strong>
<a href="#n231" name="n231">231</a>
<a href="#n232" name="n232">232</a>
<a href="#n233" name="n233">233</a>
<a href="#n234" name="n234">234</a>
<a href="#n235" name="n235">235</a>
<a href="#n236" name="n236">236</a>
<a href="#n237" name="n237">237</a>
<a href="#n238" name="n238">238</a>
<a href="#n239" name="n239">239</a>
<strong><a href="#n240" name="n240">240</a></strong>
<a href="#n241" name="n241">241</a>
<a href="#n242" name="n242">242</a>
<a href="#n243" name="n243">243</a>
<a href="#n244" name="n244">244</a>
<a href="#n245" name="n245">245</a>
<a href="#n246" name="n246">246</a>
<a href="#n247" name="n247">247</a>
<a href="#n248" name="n248">248</a>
<a href="#n249" name="n249">249</a>
<strong><a href="#n250" name="n250">250</a></strong>
<a href="#n251" name="n251">251</a>
<a href="#n252" name="n252">252</a>
<a href="#n253" name="n253">253</a>
<a href="#n254" name="n254">254</a>
<a href="#n255" name="n255">255</a>
<a href="#n256" name="n256">256</a>
<a href="#n257" name="n257">257</a>
<a href="#n258" name="n258">258</a>
<a href="#n259" name="n259">259</a>
<strong><a href="#n260" name="n260">260</a></strong>
<a href="#n261" name="n261">261</a>
<a href="#n262" name="n262">262</a>
<a href="#n263" name="n263">263</a>
<a href="#n264" name="n264">264</a>
<a href="#n265" name="n265">265</a>
<a href="#n266" name="n266">266</a>
<a href="#n267" name="n267">267</a>
<a href="#n268" name="n268">268</a>
<a href="#n269" name="n269">269</a>
<strong><a href="#n270" name="n270">270</a></strong>
<a href="#n271" name="n271">271</a>
<a href="#n272" name="n272">272</a>
<a href="#n273" name="n273">273</a>
<a href="#n274" name="n274">274</a>
<a href="#n275" name="n275">275</a>
<a href="#n276" name="n276">276</a>
<a href="#n277" name="n277">277</a>
<a href="#n278" name="n278">278</a>
<a href="#n279" name="n279">279</a>
<strong><a href="#n280" name="n280">280</a></strong>
<a href="#n281" name="n281">281</a>
<a href="#n282" name="n282">282</a>
<a href="#n283" name="n283">283</a>
<a href="#n284" name="n284">284</a>
<a href="#n285" name="n285">285</a>
<a href="#n286" name="n286">286</a>
<a href="#n287" name="n287">287</a>
<a href="#n288" name="n288">288</a>
<a href="#n289" name="n289">289</a>
<strong><a href="#n290" name="n290">290</a></strong>
<a href="#n291" name="n291">291</a>
<a href="#n292" name="n292">292</a>
<a href="#n293" name="n293">293</a>
<a href="#n294" name="n294">294</a>
<a href="#n295" name="n295">295</a>
<a href="#n296" name="n296">296</a>
<a href="#n297" name="n297">297</a>
<a href="#n298" name="n298">298</a>
<a href="#n299" name="n299">299</a>
<strong><a href="#n300" name="n300">300</a></strong>
<a href="#n301" name="n301">301</a>
<a href="#n302" name="n302">302</a>
<a href="#n303" name="n303">303</a>
<a href="#n304" name="n304">304</a>
<a href="#n305" name="n305">305</a>
<a href="#n306" name="n306">306</a>
<a href="#n307" name="n307">307</a>
<a href="#n308" name="n308">308</a>
<a href="#n309" name="n309">309</a>
<strong><a href="#n310" name="n310">310</a></strong>
<a href="#n311" name="n311">311</a>
<a href="#n312" name="n312">312</a>
<a href="#n313" name="n313">313</a>
<a href="#n314" name="n314">314</a>
<a href="#n315" name="n315">315</a>
<a href="#n316" name="n316">316</a>
<a href="#n317" name="n317">317</a>
<a href="#n318" name="n318">318</a>
<a href="#n319" name="n319">319</a>
<strong><a href="#n320" name="n320">320</a></strong>
<a href="#n321" name="n321">321</a>
<a href="#n322" name="n322">322</a>
<a href="#n323" name="n323">323</a>
<a href="#n324" name="n324">324</a>
<a href="#n325" name="n325">325</a>
<a href="#n326" name="n326">326</a>
<a href="#n327" name="n327">327</a>
<a href="#n328" name="n328">328</a>
<a href="#n329" name="n329">329</a>
<strong><a href="#n330" name="n330">330</a></strong>
<a href="#n331" name="n331">331</a>
<a href="#n332" name="n332">332</a>
<a href="#n333" name="n333">333</a>
<a href="#n334" name="n334">334</a>
<a href="#n335" name="n335">335</a>
<a href="#n336" name="n336">336</a>
<a href="#n337" name="n337">337</a>
<a href="#n338" name="n338">338</a>
<a href="#n339" name="n339">339</a>
<strong><a href="#n340" name="n340">340</a></strong>
<a href="#n341" name="n341">341</a>
<a href="#n342" name="n342">342</a>
<a href="#n343" name="n343">343</a>
<a href="#n344" name="n344">344</a>
<a href="#n345" name="n345">345</a>
<a href="#n346" name="n346">346</a>
<a href="#n347" name="n347">347</a>
<a href="#n348" name="n348">348</a>
<a href="#n349" name="n349">349</a>
<strong><a href="#n350" name="n350">350</a></strong>
<a href="#n351" name="n351">351</a>
<a href="#n352" name="n352">352</a>
<a href="#n353" name="n353">353</a>
<a href="#n354" name="n354">354</a>
<a href="#n355" name="n355">355</a>
<a href="#n356" name="n356">356</a>
<a href="#n357" name="n357">357</a>
<a href="#n358" name="n358">358</a>
<a href="#n359" name="n359">359</a>
<strong><a href="#n360" name="n360">360</a></strong>
<a href="#n361" name="n361">361</a>
<a href="#n362" name="n362">362</a>
<a href="#n363" name="n363">363</a>
<a href="#n364" name="n364">364</a>
<a href="#n365" name="n365">365</a>
<a href="#n366" name="n366">366</a>
<a href="#n367" name="n367">367</a>
<a href="#n368" name="n368">368</a>
<a href="#n369" name="n369">369</a>
<strong><a href="#n370" name="n370">370</a></strong>
<a href="#n371" name="n371">371</a>
<a href="#n372" name="n372">372</a>
<a href="#n373" name="n373">373</a>
<a href="#n374" name="n374">374</a>
<a href="#n375" name="n375">375</a>
<a href="#n376" name="n376">376</a>
<a href="#n377" name="n377">377</a>
<a href="#n378" name="n378">378</a>
<a href="#n379" name="n379">379</a>
<strong><a href="#n380" name="n380">380</a></strong>
<a href="#n381" name="n381">381</a>
<a href="#n382" name="n382">382</a>
<a href="#n383" name="n383">383</a>
<a href="#n384" name="n384">384</a>
<a href="#n385" name="n385">385</a>
<a href="#n386" name="n386">386</a>
<a href="#n387" name="n387">387</a>
<a href="#n388" name="n388">388</a>
<a href="#n389" name="n389">389</a>
<strong><a href="#n390" name="n390">390</a></strong>
<a href="#n391" name="n391">391</a>
<a href="#n392" name="n392">392</a>
<a href="#n393" name="n393">393</a>
<a href="#n394" name="n394">394</a>
<a href="#n395" name="n395">395</a>
<a href="#n396" name="n396">396</a>
<a href="#n397" name="n397">397</a>
<a href="#n398" name="n398">398</a>
<a href="#n399" name="n399">399</a>
<strong><a href="#n400" name="n400">400</a></strong>
<a href="#n401" name="n401">401</a>
<a href="#n402" name="n402">402</a>
<a href="#n403" name="n403">403</a>
<a href="#n404" name="n404">404</a>
<a href="#n405" name="n405">405</a>
<a href="#n406" name="n406">406</a>
<a href="#n407" name="n407">407</a>
<a href="#n408" name="n408">408</a>
<a href="#n409" name="n409">409</a>
<strong><a href="#n410" name="n410">410</a></strong>
<a href="#n411" name="n411">411</a>
<a href="#n412" name="n412">412</a>
<a href="#n413" name="n413">413</a>
<a href="#n414" name="n414">414</a>
<a href="#n415" name="n415">415</a>
<a href="#n416" name="n416">416</a>
<a href="#n417" name="n417">417</a>
<a href="#n418" name="n418">418</a>
<a href="#n419" name="n419">419</a>
<strong><a href="#n420" name="n420">420</a></strong>
<a href="#n421" name="n421">421</a>
<a href="#n422" name="n422">422</a>
<a href="#n423" name="n423">423</a>
<a href="#n424" name="n424">424</a>
<a href="#n425" name="n425">425</a>
<a href="#n426" name="n426">426</a>
<a href="#n427" name="n427">427</a>
<a href="#n428" name="n428">428</a>
<a href="#n429" name="n429">429</a>
<strong><a href="#n430" name="n430">430</a></strong>
<a href="#n431" name="n431">431</a>
<a href="#n432" name="n432">432</a>
<a href="#n433" name="n433">433</a>
<a href="#n434" name="n434">434</a>
<a href="#n435" name="n435">435</a>
<a href="#n436" name="n436">436</a>
<a href="#n437" name="n437">437</a>
<a href="#n438" name="n438">438</a>
<a href="#n439" name="n439">439</a>
<strong><a href="#n440" name="n440">440</a></strong>
<a href="#n441" name="n441">441</a>
<a href="#n442" name="n442">442</a>
<a href="#n443" name="n443">443</a>
<a href="#n444" name="n444">444</a>
<a href="#n445" name="n445">445</a>
<a href="#n446" name="n446">446</a>
<a href="#n447" name="n447">447</a>
<a href="#n448" name="n448">448</a>
<a href="#n449" name="n449">449</a>
<strong><a href="#n450" name="n450">450</a></strong>
<a href="#n451" name="n451">451</a>
<a href="#n452" name="n452">452</a>
<a href="#n453" name="n453">453</a>
<a href="#n454" name="n454">454</a>
<a href="#n455" name="n455">455</a>
<a href="#n456" name="n456">456</a>
<a href="#n457" name="n457">457</a>
<a href="#n458" name="n458">458</a>
<a href="#n459" name="n459">459</a>
<strong><a href="#n460" name="n460">460</a></strong>
<a href="#n461" name="n461">461</a>
<a href="#n462" name="n462">462</a>
<a href="#n463" name="n463">463</a>
<a href="#n464" name="n464">464</a>
<a href="#n465" name="n465">465</a>
<a href="#n466" name="n466">466</a>
<a href="#n467" name="n467">467</a>
<a href="#n468" name="n468">468</a>
<a href="#n469" name="n469">469</a>
<strong><a href="#n470" name="n470">470</a></strong>
<a href="#n471" name="n471">471</a>
<a href="#n472" name="n472">472</a>
<a href="#n473" name="n473">473</a>
<a href="#n474" name="n474">474</a>
<a href="#n475" name="n475">475</a>
<a href="#n476" name="n476">476</a>
<a href="#n477" name="n477">477</a>
<a href="#n478" name="n478">478</a>
<a href="#n479" name="n479">479</a>
<strong><a href="#n480" name="n480">480</a></strong>
<a href="#n481" name="n481">481</a>
<a href="#n482" name="n482">482</a>
<a href="#n483" name="n483">483</a>
<a href="#n484" name="n484">484</a>
<a href="#n485" name="n485">485</a>
<a href="#n486" name="n486">486</a>
<a href="#n487" name="n487">487</a>
<a href="#n488" name="n488">488</a>
<a href="#n489" name="n489">489</a>
<strong><a href="#n490" name="n490">490</a></strong>
<a href="#n491" name="n491">491</a>
<a href="#n492" name="n492">492</a>
<a href="#n493" name="n493">493</a>
<a href="#n494" name="n494">494</a>
<a href="#n495" name="n495">495</a>
<a href="#n496" name="n496">496</a>
<a href="#n497" name="n497">497</a>
<a href="#n498" name="n498">498</a>
<a href="#n499" name="n499">499</a>
<strong><a href="#n500" name="n500">500</a></strong>
<a href="#n501" name="n501">501</a>
<a href="#n502" name="n502">502</a>
<a href="#n503" name="n503">503</a>
<a href="#n504" name="n504">504</a>
<a href="#n505" name="n505">505</a>
<a href="#n506" name="n506">506</a>
<a href="#n507" name="n507">507</a>
<a href="#n508" name="n508">508</a>
<a href="#n509" name="n509">509</a>
<strong><a href="#n510" name="n510">510</a></strong>
<a href="#n511" name="n511">511</a>
<a href="#n512" name="n512">512</a>
<a href="#n513" name="n513">513</a>
<a href="#n514" name="n514">514</a>
<a href="#n515" name="n515">515</a>
<a href="#n516" name="n516">516</a>
<a href="#n517" name="n517">517</a>
<a href="#n518" name="n518">518</a>
<a href="#n519" name="n519">519</a>
<strong><a href="#n520" name="n520">520</a></strong>
<a href="#n521" name="n521">521</a>
<a href="#n522" name="n522">522</a>
<a href="#n523" name="n523">523</a>
<a href="#n524" name="n524">524</a>
<a href="#n525" name="n525">525</a>
<a href="#n526" name="n526">526</a>
<a href="#n527" name="n527">527</a>
<a href="#n528" name="n528">528</a>
<a href="#n529" name="n529">529</a>
<strong><a href="#n530" name="n530">530</a></strong>
<a href="#n531" name="n531">531</a>
<a href="#n532" name="n532">532</a>
<a href="#n533" name="n533">533</a>
<a href="#n534" name="n534">534</a>
<a href="#n535" name="n535">535</a>
<a href="#n536" name="n536">536</a>
<a href="#n537" name="n537">537</a>
<a href="#n538" name="n538">538</a>
<a href="#n539" name="n539">539</a>
<strong><a href="#n540" name="n540">540</a></strong>
<a href="#n541" name="n541">541</a>
<a href="#n542" name="n542">542</a>
<a href="#n543" name="n543">543</a>
<a href="#n544" name="n544">544</a>
<a href="#n545" name="n545">545</a>
<a href="#n546" name="n546">546</a>
<a href="#n547" name="n547">547</a>
<a href="#n548" name="n548">548</a>
<a href="#n549" name="n549">549</a>
<strong><a href="#n550" name="n550">550</a></strong>
<a href="#n551" name="n551">551</a>
<a href="#n552" name="n552">552</a>
<a href="#n553" name="n553">553</a>
<a href="#n554" name="n554">554</a>
<a href="#n555" name="n555">555</a>
<a href="#n556" name="n556">556</a>
<a href="#n557" name="n557">557</a>
<a href="#n558" name="n558">558</a>
<a href="#n559" name="n559">559</a>
<strong><a href="#n560" name="n560">560</a></strong>
<a href="#n561" name="n561">561</a>
<a href="#n562" name="n562">562</a>
<a href="#n563" name="n563">563</a>
<a href="#n564" name="n564">564</a>
<a href="#n565" name="n565">565</a>
<a href="#n566" name="n566">566</a>
<a href="#n567" name="n567">567</a>
<a href="#n568" name="n568">568</a>
<a href="#n569" name="n569">569</a>
<strong><a href="#n570" name="n570">570</a></strong>
<a href="#n571" name="n571">571</a>
<a href="#n572" name="n572">572</a>
<a href="#n573" name="n573">573</a>
<a href="#n574" name="n574">574</a>
<a href="#n575" name="n575">575</a>
<a href="#n576" name="n576">576</a>
<a href="#n577" name="n577">577</a>
<a href="#n578" name="n578">578</a>
<a href="#n579" name="n579">579</a>
<strong><a href="#n580" name="n580">580</a></strong>
<a href="#n581" name="n581">581</a>
<a href="#n582" name="n582">582</a>
<a href="#n583" name="n583">583</a>
<a href="#n584" name="n584">584</a>
<a href="#n585" name="n585">585</a>
<a href="#n586" name="n586">586</a>
<a href="#n587" name="n587">587</a>
<a href="#n588" name="n588">588</a>
<a href="#n589" name="n589">589</a>
<strong><a href="#n590" name="n590">590</a></strong>
<a href="#n591" name="n591">591</a>
<a href="#n592" name="n592">592</a>
<a href="#n593" name="n593">593</a>
<a href="#n594" name="n594">594</a>
<a href="#n595" name="n595">595</a>
<a href="#n596" name="n596">596</a>
<a href="#n597" name="n597">597</a>
<a href="#n598" name="n598">598</a>
<a href="#n599" name="n599">599</a>
<strong><a href="#n600" name="n600">600</a></strong>
<a href="#n601" name="n601">601</a>
<a href="#n602" name="n602">602</a>
<a href="#n603" name="n603">603</a>
<a href="#n604" name="n604">604</a>
<a href="#n605" name="n605">605</a>
<a href="#n606" name="n606">606</a>
<a href="#n607" name="n607">607</a>
<a href="#n608" name="n608">608</a>
<a href="#n609" name="n609">609</a>
<strong><a href="#n610" name="n610">610</a></strong>
<a href="#n611" name="n611">611</a>
<a href="#n612" name="n612">612</a>
<a href="#n613" name="n613">613</a>
<a href="#n614" name="n614">614</a>
<a href="#n615" name="n615">615</a>
<a href="#n616" name="n616">616</a>
<a href="#n617" name="n617">617</a>
<a href="#n618" name="n618">618</a>
<a href="#n619" name="n619">619</a>
<strong><a href="#n620" name="n620">620</a></strong>
<a href="#n621" name="n621">621</a>
<a href="#n622" name="n622">622</a>
<a href="#n623" name="n623">623</a>
<a href="#n624" name="n624">624</a>
<a href="#n625" name="n625">625</a>
<a href="#n626" name="n626">626</a>
<a href="#n627" name="n627">627</a>
<a href="#n628" name="n628">628</a>
<a href="#n629" name="n629">629</a>
<strong><a href="#n630" name="n630">630</a></strong>
<a href="#n631" name="n631">631</a>
<a href="#n632" name="n632">632</a>
<a href="#n633" name="n633">633</a>
<a href="#n634" name="n634">634</a>
<a href="#n635" name="n635">635</a>
<a href="#n636" name="n636">636</a>
<a href="#n637" name="n637">637</a>
<a href="#n638" name="n638">638</a>
<a href="#n639" name="n639">639</a>
<strong><a href="#n640" name="n640">640</a></strong>
<a href="#n641" name="n641">641</a>
<a href="#n642" name="n642">642</a>
<a href="#n643" name="n643">643</a>
<a href="#n644" name="n644">644</a>
<a href="#n645" name="n645">645</a>
<a href="#n646" name="n646">646</a>
<a href="#n647" name="n647">647</a>
<a href="#n648" name="n648">648</a>
<a href="#n649" name="n649">649</a>
<strong><a href="#n650" name="n650">650</a></strong>
<a href="#n651" name="n651">651</a>
<a href="#n652" name="n652">652</a>
<a href="#n653" name="n653">653</a>
<a href="#n654" name="n654">654</a>
<a href="#n655" name="n655">655</a>
<a href="#n656" name="n656">656</a>
<a href="#n657" name="n657">657</a>
<a href="#n658" name="n658">658</a>
<a href="#n659" name="n659">659</a>
<strong><a href="#n660" name="n660">660</a></strong>
<a href="#n661" name="n661">661</a>
<a href="#n662" name="n662">662</a>
<a href="#n663" name="n663">663</a>
<a href="#n664" name="n664">664</a>
<a href="#n665" name="n665">665</a>
<a href="#n666" name="n666">666</a>
<a href="#n667" name="n667">667</a>
<a href="#n668" name="n668">668</a>
<a href="#n669" name="n669">669</a>
<strong><a href="#n670" name="n670">670</a></strong>
<a href="#n671" name="n671">671</a>
<a href="#n672" name="n672">672</a>
<a href="#n673" name="n673">673</a>
<a href="#n674" name="n674">674</a>
<a href="#n675" name="n675">675</a>
<a href="#n676" name="n676">676</a>
<a href="#n677" name="n677">677</a>
<a href="#n678" name="n678">678</a>
<a href="#n679" name="n679">679</a>
<strong><a href="#n680" name="n680">680</a></strong>
<a href="#n681" name="n681">681</a>
<a href="#n682" name="n682">682</a>
<a href="#n683" name="n683">683</a>
<a href="#n684" name="n684">684</a>
<a href="#n685" name="n685">685</a>
<a href="#n686" name="n686">686</a>
<a href="#n687" name="n687">687</a>
<a href="#n688" name="n688">688</a>
<a href="#n689" name="n689">689</a>
<strong><a href="#n690" name="n690">690</a></strong>
<a href="#n691" name="n691">691</a>
<a href="#n692" name="n692">692</a>
<a href="#n693" name="n693">693</a>
<a href="#n694" name="n694">694</a>
<a href="#n695" name="n695">695</a>
<a href="#n696" name="n696">696</a>
<a href="#n697" name="n697">697</a>
<a href="#n698" name="n698">698</a>
<a href="#n699" name="n699">699</a>
<strong><a href="#n700" name="n700">700</a></strong>
<a href="#n701" name="n701">701</a>
<a href="#n702" name="n702">702</a>
<a href="#n703" name="n703">703</a>
<a href="#n704" name="n704">704</a>
<a href="#n705" name="n705">705</a>
<a href="#n706" name="n706">706</a>
<a href="#n707" name="n707">707</a>
<a href="#n708" name="n708">708</a>
<a href="#n709" name="n709">709</a>
<strong><a href="#n710" name="n710">710</a></strong>
<a href="#n711" name="n711">711</a>
<a href="#n712" name="n712">712</a>
<a href="#n713" name="n713">713</a>
<a href="#n714" name="n714">714</a>
<a href="#n715" name="n715">715</a>
<a href="#n716" name="n716">716</a>
<a href="#n717" name="n717">717</a>
<a href="#n718" name="n718">718</a>
<a href="#n719" name="n719">719</a>
<strong><a href="#n720" name="n720">720</a></strong>
<a href="#n721" name="n721">721</a>
<a href="#n722" name="n722">722</a>
<a href="#n723" name="n723">723</a>
<a href="#n724" name="n724">724</a>
<a href="#n725" name="n725">725</a>
<a href="#n726" name="n726">726</a>
<a href="#n727" name="n727">727</a>
<a href="#n728" name="n728">728</a>
<a href="#n729" name="n729">729</a>
<strong><a href="#n730" name="n730">730</a></strong>
<a href="#n731" name="n731">731</a>
<a href="#n732" name="n732">732</a>
<a href="#n733" name="n733">733</a>
<a href="#n734" name="n734">734</a>
<a href="#n735" name="n735">735</a>
<a href="#n736" name="n736">736</a>
<a href="#n737" name="n737">737</a>
<a href="#n738" name="n738">738</a>
<a href="#n739" name="n739">739</a>
<strong><a href="#n740" name="n740">740</a></strong>
<a href="#n741" name="n741">741</a>
<a href="#n742" name="n742">742</a>
<a href="#n743" name="n743">743</a>
<a href="#n744" name="n744">744</a>
<a href="#n745" name="n745">745</a>
<a href="#n746" name="n746">746</a>
<a href="#n747" name="n747">747</a>
<a href="#n748" name="n748">748</a>
<a href="#n749" name="n749">749</a>
<strong><a href="#n750" name="n750">750</a></strong>
<a href="#n751" name="n751">751</a>
<a href="#n752" name="n752">752</a>
<a href="#n753" name="n753">753</a>
<a href="#n754" name="n754">754</a>
<a href="#n755" name="n755">755</a>
<a href="#n756" name="n756">756</a>
<a href="#n757" name="n757">757</a>
<a href="#n758" name="n758">758</a>
<a href="#n759" name="n759">759</a>
<strong><a href="#n760" name="n760">760</a></strong>
<a href="#n761" name="n761">761</a>
<a href="#n762" name="n762">762</a>
<a href="#n763" name="n763">763</a>
<a href="#n764" name="n764">764</a>
<a href="#n765" name="n765">765</a>
<a href="#n766" name="n766">766</a>
<a href="#n767" name="n767">767</a>
<a href="#n768" name="n768">768</a>
<a href="#n769" name="n769">769</a>
<strong><a href="#n770" name="n770">770</a></strong>
<a href="#n771" name="n771">771</a>
<a href="#n772" name="n772">772</a>
<a href="#n773" name="n773">773</a>
<a href="#n774" name="n774">774</a>
<a href="#n775" name="n775">775</a>
<a href="#n776" name="n776">776</a>
<a href="#n777" name="n777">777</a>
<a href="#n778" name="n778">778</a>
<a href="#n779" name="n779">779</a>
<strong><a href="#n780" name="n780">780</a></strong>
<a href="#n781" name="n781">781</a>
<a href="#n782" name="n782">782</a>
<a href="#n783" name="n783">783</a>
<a href="#n784" name="n784">784</a>
<a href="#n785" name="n785">785</a>
<a href="#n786" name="n786">786</a>
<a href="#n787" name="n787">787</a>
<a href="#n788" name="n788">788</a>
<a href="#n789" name="n789">789</a>
<strong><a href="#n790" name="n790">790</a></strong>
<a href="#n791" name="n791">791</a>
<a href="#n792" name="n792">792</a>
<a href="#n793" name="n793">793</a>
<a href="#n794" name="n794">794</a>
<a href="#n795" name="n795">795</a>
<a href="#n796" name="n796">796</a>
<a href="#n797" name="n797">797</a>
<a href="#n798" name="n798">798</a>
<a href="#n799" name="n799">799</a>
<strong><a href="#n800" name="n800">800</a></strong>
<a href="#n801" name="n801">801</a>
<a href="#n802" name="n802">802</a>
<a href="#n803" name="n803">803</a>
<a href="#n804" name="n804">804</a>
<a href="#n805" name="n805">805</a>
<a href="#n806" name="n806">806</a>
<a href="#n807" name="n807">807</a>
<a href="#n808" name="n808">808</a>
<a href="#n809" name="n809">809</a>
<strong><a href="#n810" name="n810">810</a></strong>
<a href="#n811" name="n811">811</a>
<a href="#n812" name="n812">812</a>
<a href="#n813" name="n813">813</a>
<a href="#n814" name="n814">814</a>
<a href="#n815" name="n815">815</a>
<a href="#n816" name="n816">816</a>
<a href="#n817" name="n817">817</a>
<a href="#n818" name="n818">818</a>
<a href="#n819" name="n819">819</a>
<strong><a href="#n820" name="n820">820</a></strong>
<a href="#n821" name="n821">821</a>
<a href="#n822" name="n822">822</a>
<a href="#n823" name="n823">823</a>
<a href="#n824" name="n824">824</a>
<a href="#n825" name="n825">825</a>
<a href="#n826" name="n826">826</a>
<a href="#n827" name="n827">827</a>
<a href="#n828" name="n828">828</a>
<a href="#n829" name="n829">829</a>
<strong><a href="#n830" name="n830">830</a></strong>
<a href="#n831" name="n831">831</a>
<a href="#n832" name="n832">832</a>
<a href="#n833" name="n833">833</a>
<a href="#n834" name="n834">834</a>
<a href="#n835" name="n835">835</a>
<a href="#n836" name="n836">836</a>
<a href="#n837" name="n837">837</a>
<a href="#n838" name="n838">838</a>
<a href="#n839" name="n839">839</a>
<strong><a href="#n840" name="n840">840</a></strong>
<a href="#n841" name="n841">841</a>
<a href="#n842" name="n842">842</a>
<a href="#n843" name="n843">843</a>
<a href="#n844" name="n844">844</a>
<a href="#n845" name="n845">845</a>
<a href="#n846" name="n846">846</a>
<a href="#n847" name="n847">847</a>
<a href="#n848" name="n848">848</a>
<a href="#n849" name="n849">849</a>
<strong><a href="#n850" name="n850">850</a></strong>
<a href="#n851" name="n851">851</a>
<a href="#n852" name="n852">852</a>
<a href="#n853" name="n853">853</a>
<a href="#n854" name="n854">854</a>
<a href="#n855" name="n855">855</a>
<a href="#n856" name="n856">856</a>
<a href="#n857" name="n857">857</a>
<a href="#n858" name="n858">858</a>
<a href="#n859" name="n859">859</a>
<strong><a href="#n860" name="n860">860</a></strong>
<a href="#n861" name="n861">861</a>
<a href="#n862" name="n862">862</a>
<a href="#n863" name="n863">863</a>
<a href="#n864" name="n864">864</a>
<a href="#n865" name="n865">865</a>
<a href="#n866" name="n866">866</a>
<a href="#n867" name="n867">867</a>
<a href="#n868" name="n868">868</a>
<a href="#n869" name="n869">869</a>
<strong><a href="#n870" name="n870">870</a></strong>
<a href="#n871" name="n871">871</a>
<a href="#n872" name="n872">872</a>
<a href="#n873" name="n873">873</a>
<a href="#n874" name="n874">874</a>
<a href="#n875" name="n875">875</a>
<a href="#n876" name="n876">876</a>
<a href="#n877" name="n877">877</a>
<a href="#n878" name="n878">878</a>
<a href="#n879" name="n879">879</a>
<strong><a href="#n880" name="n880">880</a></strong>
<a href="#n881" name="n881">881</a>
<a href="#n882" name="n882">882</a>
<a href="#n883" name="n883">883</a>
<a href="#n884" name="n884">884</a>
<a href="#n885" name="n885">885</a>
<a href="#n886" name="n886">886</a>
<a href="#n887" name="n887">887</a>
<a href="#n888" name="n888">888</a>
<a href="#n889" name="n889">889</a>
<strong><a href="#n890" name="n890">890</a></strong>
<a href="#n891" name="n891">891</a>
<a href="#n892" name="n892">892</a>
<a href="#n893" name="n893">893</a>
<a href="#n894" name="n894">894</a>
<a href="#n895" name="n895">895</a>
<a href="#n896" name="n896">896</a>
<a href="#n897" name="n897">897</a>
<a href="#n898" name="n898">898</a>
<a href="#n899" name="n899">899</a>
<strong><a href="#n900" name="n900">900</a></strong>
<a href="#n901" name="n901">901</a>
<a href="#n902" name="n902">902</a>
<a href="#n903" name="n903">903</a>
<a href="#n904" name="n904">904</a>
<a href="#n905" name="n905">905</a>
<a href="#n906" name="n906">906</a>
<a href="#n907" name="n907">907</a>
<a href="#n908" name="n908">908</a>
<a href="#n909" name="n909">909</a>
<strong><a href="#n910" name="n910">910</a></strong>
<a href="#n911" name="n911">911</a>
<a href="#n912" name="n912">912</a>
<a href="#n913" name="n913">913</a>
<a href="#n914" name="n914">914</a>
<a href="#n915" name="n915">915</a>
<a href="#n916" name="n916">916</a>
<a href="#n917" name="n917">917</a>
<a href="#n918" name="n918">918</a>
<a href="#n919" name="n919">919</a>
<strong><a href="#n920" name="n920">920</a></strong>
<a href="#n921" name="n921">921</a>
<a href="#n922" name="n922">922</a>
<a href="#n923" name="n923">923</a>
<a href="#n924" name="n924">924</a>
<a href="#n925" name="n925">925</a>
<a href="#n926" name="n926">926</a>
<a href="#n927" name="n927">927</a>
<a href="#n928" name="n928">928</a>
<a href="#n929" name="n929">929</a>
<strong><a href="#n930" name="n930">930</a></strong>
<a href="#n931" name="n931">931</a>
<a href="#n932" name="n932">932</a>
<a href="#n933" name="n933">933</a>
<a href="#n934" name="n934">934</a>
<a href="#n935" name="n935">935</a>
<a href="#n936" name="n936">936</a>
<a href="#n937" name="n937">937</a>
<a href="#n938" name="n938">938</a>
<a href="#n939" name="n939">939</a>
<strong><a href="#n940" name="n940">940</a></strong>
<a href="#n941" name="n941">941</a>
<a href="#n942" name="n942">942</a>
<a href="#n943" name="n943">943</a>
<a href="#n944" name="n944">944</a>
<a href="#n945" name="n945">945</a>
<a href="#n946" name="n946">946</a>
<a href="#n947" name="n947">947</a>
<a href="#n948" name="n948">948</a>
<a href="#n949" name="n949">949</a>
<strong><a href="#n950" name="n950">950</a></strong>
<a href="#n951" name="n951">951</a>
<a href="#n952" name="n952">952</a>
<a href="#n953" name="n953">953</a>
<a href="#n954" name="n954">954</a>
<a href="#n955" name="n955">955</a>
<a href="#n956" name="n956">956</a>
<a href="#n957" name="n957">957</a>
<a href="#n958" name="n958">958</a>
<a href="#n959" name="n959">959</a>
<strong><a href="#n960" name="n960">960</a></strong>
<a href="#n961" name="n961">961</a>
<a href="#n962" name="n962">962</a>
<a href="#n963" name="n963">963</a>
<a href="#n964" name="n964">964</a>
<a href="#n965" name="n965">965</a>
<a href="#n966" name="n966">966</a>
<a href="#n967" name="n967">967</a>
<a href="#n968" name="n968">968</a>
<a href="#n969" name="n969">969</a>
<strong><a href="#n970" name="n970">970</a></strong>
<a href="#n971" name="n971">971</a>
<a href="#n972" name="n972">972</a>
<a href="#n973" name="n973">973</a>
<a href="#n974" name="n974">974</a>
<a href="#n975" name="n975">975</a>
<a href="#n976" name="n976">976</a>
<a href="#n977" name="n977">977</a>
<a href="#n978" name="n978">978</a>
<a href="#n979" name="n979">979</a>
<strong><a href="#n980" name="n980">980</a></strong>
<a href="#n981" name="n981">981</a>
<a href="#n982" name="n982">982</a>
<a href="#n983" name="n983">983</a>
<a href="#n984" name="n984">984</a>
<a href="#n985" name="n985">985</a>
<a href="#n986" name="n986">986</a>
<a href="#n987" name="n987">987</a>
<a href="#n988" name="n988">988</a>
<a href="#n989" name="n989">989</a>
<strong><a href="#n990" name="n990">990</a></strong>
<a href="#n991" name="n991">991</a>
<a href="#n992" name="n992">992</a>
<a href="#n993" name="n993">993</a>
<a href="#n994" name="n994">994</a>
<a href="#n995" name="n995">995</a>
<a href="#n996" name="n996">996</a>
<a href="#n997" name="n997">997</a>
<a href="#n998" name="n998">998</a>
<a href="#n999" name="n999">999</a>
<strong><a href="#n1000" name="n1000">1000</a></strong>
<a href="#n1001" name="n1001">1001</a>
<a href="#n1002" name="n1002">1002</a>
<a href="#n1003" name="n1003">1003</a>
<a href="#n1004" name="n1004">1004</a>
<a href="#n1005" name="n1005">1005</a>
<a href="#n1006" name="n1006">1006</a>
<a href="#n1007" name="n1007">1007</a>
<a href="#n1008" name="n1008">1008</a>
<a href="#n1009" name="n1009">1009</a>
<strong><a href="#n1010" name="n1010">1010</a></strong>
<a href="#n1011" name="n1011">1011</a>
<a href="#n1012" name="n1012">1012</a>
<a href="#n1013" name="n1013">1013</a>
<a href="#n1014" name="n1014">1014</a>
<a href="#n1015" name="n1015">1015</a>
<a href="#n1016" name="n1016">1016</a>
<a href="#n1017" name="n1017">1017</a>
<a href="#n1018" name="n1018">1018</a>
<a href="#n1019" name="n1019">1019</a>
<strong><a href="#n1020" name="n1020">1020</a></strong>
<a href="#n1021" name="n1021">1021</a>
<a href="#n1022" name="n1022">1022</a>
<a href="#n1023" name="n1023">1023</a>
<a href="#n1024" name="n1024">1024</a>
<a href="#n1025" name="n1025">1025</a>
<a href="#n1026" name="n1026">1026</a>
<a href="#n1027" name="n1027">1027</a>
<a href="#n1028" name="n1028">1028</a>
<a href="#n1029" name="n1029">1029</a>
<strong><a href="#n1030" name="n1030">1030</a></strong>
<a href="#n1031" name="n1031">1031</a>
<a href="#n1032" name="n1032">1032</a>
<a href="#n1033" name="n1033">1033</a>
<a href="#n1034" name="n1034">1034</a>
<a href="#n1035" name="n1035">1035</a>
<a href="#n1036" name="n1036">1036</a>
<a href="#n1037" name="n1037">1037</a>
<a href="#n1038" name="n1038">1038</a>
<a href="#n1039" name="n1039">1039</a>
<strong><a href="#n1040" name="n1040">1040</a></strong>
<a href="#n1041" name="n1041">1041</a>
<a href="#n1042" name="n1042">1042</a>
<a href="#n1043" name="n1043">1043</a>
<a href="#n1044" name="n1044">1044</a>
<a href="#n1045" name="n1045">1045</a>
<a href="#n1046" name="n1046">1046</a>
<a href="#n1047" name="n1047">1047</a>
<a href="#n1048" name="n1048">1048</a>
<a href="#n1049" name="n1049">1049</a>
<strong><a href="#n1050" name="n1050">1050</a></strong>
<a href="#n1051" name="n1051">1051</a>
<a href="#n1052" name="n1052">1052</a>
<a href="#n1053" name="n1053">1053</a>
<a href="#n1054" name="n1054">1054</a>
<a href="#n1055" name="n1055">1055</a>
<a href="#n1056" name="n1056">1056</a>
<a href="#n1057" name="n1057">1057</a>
<a href="#n1058" name="n1058">1058</a>
<a href="#n1059" name="n1059">1059</a>
<strong><a href="#n1060" name="n1060">1060</a></strong>
<a href="#n1061" name="n1061">1061</a>
<a href="#n1062" name="n1062">1062</a>
<a href="#n1063" name="n1063">1063</a>
</pre></td>
  <td class="code"><pre><span class="comment">/* DreemGL is a collaboration between Teeming Society &amp; Samsung Electronics, sponsored by Samsung and others.
   Copyright 2015-2016 Teeming Society. Licensed under the Apache License, Version 2.0 (the 'License'); You may not use this file except in compliance with the License.
   You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing,
   software distributed under the License is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and limitations under the License. */</span>

define.<span class="reserved">class</span>(<span class="string"><span class="delimiter">'</span><span class="content">$ui/view</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(require, <span class="predefined">$ui$</span>, view, label, button, labelset, <span class="predefined">$$</span>, geo, urlfetch)
{

        <span class="keyword">var</span> BufferGen = require(<span class="string"><span class="delimiter">'</span><span class="content">$widgets/map/mapbuffers</span><span class="delimiter">'</span></span>)()
        <span class="keyword">var</span> geo = <span class="local-variable">this</span>.geo = geo()
        <span class="keyword">var</span> ubuntufont = require(<span class="string"><span class="delimiter">'</span><span class="content">$resources/fonts/ubuntu_medium_256_baked.glf</span><span class="delimiter">'</span></span>)

        <span class="local-variable">this</span>.attributes = {
                <span class="comment">// TODO(aki): Why latlong inverse?</span>
                <span class="key">latlong</span>:  Config({<span class="key">type</span>: vec2, <span class="key">value</span>: vec2(<span class="float">52.3608307</span>, <span class="float">4.8626387</span>)}),
                <span class="key">zoomlevel</span>: Config({<span class="key">type</span>: Number, <span class="key">value</span>: <span class="integer">16</span>}),
                <span class="key">latlongchange</span>: Config({<span class="key">type</span>: Event}),
                <span class="key">showlabels</span>: Config({<span class="key">type</span>: Boolean, <span class="key">value</span>: <span class="predefined-constant">false</span>})
        }

        <span class="keyword">function</span> <span class="function">createHash</span> (x, y, z) {
                <span class="keyword">return</span> x + <span class="string"><span class="delimiter">'</span><span class="content">_</span><span class="delimiter">'</span></span> + y + <span class="string"><span class="delimiter">'</span><span class="content">_</span><span class="delimiter">'</span></span> + z
        }

        <span class="local-variable">this</span>.<span class="function">zoomTo</span> = <span class="keyword">function</span>(z, time) {
                <span class="local-variable">this</span>.dataset.zoomTo(z, time)
        }

        <span class="local-variable">this</span>.<span class="function">onpointerwheel</span> = <span class="keyword">function</span>(ev) {
                <span class="keyword">if</span> (!ev.touch) {
                        <span class="local-variable">this</span>.zoomTo(<span class="local-variable">this</span>.dataset.zoomlevel - ev.wheel[<span class="integer">1</span>] / <span class="integer">120</span>)
                        <span class="local-variable">this</span>.clearTimeout(<span class="local-variable">this</span>.zoomTimeout)
                        <span class="local-variable">this</span>.zoomTimeout = <span class="local-variable">this</span>.setTimeout(<span class="keyword">function</span>() {
                                <span class="local-variable">this</span>.emitUpward(<span class="string"><span class="delimiter">'</span><span class="content">latlongchange</span><span class="delimiter">'</span></span>, [<span class="local-variable">this</span>.latlong[<span class="integer">0</span>], <span class="local-variable">this</span>.latlong[<span class="integer">1</span>], <span class="local-variable">this</span>.zoomlevel])
                        }.bind(<span class="local-variable">this</span>), <span class="integer">100</span>)
                }
        }

        <span class="local-variable">this</span>.<span class="function">onpointerstart</span> = <span class="keyword">function</span>(ev) {
                <span class="local-variable">this</span>.dragging = <span class="predefined-constant">true</span>
        }

        <span class="local-variable">this</span>.<span class="function">onpointermultimove</span> = <span class="keyword">function</span>(ev) {
                <span class="keyword">if</span> (!<span class="local-variable">this</span>.dragging) <span class="keyword">return</span>
                <span class="keyword">if</span> (ev.length == <span class="integer">1</span>) {
                        <span class="local-variable">this</span>.panByVectorMovement(ev[<span class="integer">0</span>].position, ev[<span class="integer">0</span>].movement)
                } <span class="keyword">else</span> <span class="keyword">if</span> (ev.length == <span class="integer">2</span>) {
                        <span class="keyword">var</span> center = vec2.mix(ev[<span class="integer">0</span>].position, ev[<span class="integer">1</span>].position, <span class="float">0.5</span>)
                        <span class="keyword">var</span> movement = vec2.mix(ev[<span class="integer">0</span>].movement, ev[<span class="integer">1</span>].movement, <span class="float">0.5</span>)
                        <span class="local-variable">this</span>.panByVectorMovement(center, movement)
                        <span class="keyword">var</span> distance = vec2.distance(ev[<span class="integer">0</span>].position, ev[<span class="integer">1</span>].position)
                        <span class="keyword">var</span> distanceOld = vec2.distance(
                                vec2.sub(ev[<span class="integer">0</span>].position, ev[<span class="integer">0</span>].movement),
                                vec2.sub(ev[<span class="integer">1</span>].position, ev[<span class="integer">1</span>].movement)
                        )
                        <span class="keyword">var</span> distanceDelta = (distance - distanceOld) / <span class="local-variable">this</span>.layout.width * <span class="integer">5</span>
                        <span class="local-variable">this</span>.zoomTo(<span class="local-variable">this</span>.dataset.zoomlevel + distanceDelta)
                }
        }

        <span class="local-variable">this</span>.<span class="function">panByVectorMovement</span> = <span class="keyword">function</span> (vector, movement) {
                <span class="keyword">var</span> startPos = vec2.sub(vector, movement)
                <span class="keyword">var</span> R = <span class="local-variable">this</span>.projectonplane(<span class="local-variable">this</span>.globalToLocal(startPos))
                <span class="keyword">if</span> (R) {
                        <span class="local-variable">this</span>.prevvect = vec2(R[<span class="integer">0</span>] / (BufferGen.TileSize * <span class="integer">16</span>), R[<span class="integer">2</span>] / (BufferGen.TileSize * <span class="integer">16</span>))
                }
                R = <span class="local-variable">this</span>.projectonplane(<span class="local-variable">this</span>.globalToLocal(vector));
                <span class="keyword">if</span> (R) {
                        <span class="local-variable">this</span>.newvect = vec2(R[<span class="integer">0</span>] / (BufferGen.TileSize * <span class="integer">16</span>),R[<span class="integer">2</span>] / (BufferGen.TileSize * <span class="integer">16</span>))
                        <span class="keyword">var</span> metoffset = vec2(
                                (<span class="local-variable">this</span>.newvect[<span class="integer">0</span>] - <span class="local-variable">this</span>.prevvect[<span class="integer">0</span>]) * geo.metersPerTile(<span class="local-variable">this</span>.zoomlevel) * Math.pow(<span class="float">2.0</span>, -<span class="local-variable">this</span>.fraczoom),
                                -(<span class="local-variable">this</span>.newvect[<span class="integer">1</span>] - <span class="local-variable">this</span>.prevvect[<span class="integer">1</span>]) * geo.metersPerTile(<span class="local-variable">this</span>.zoomlevel) * Math.pow(<span class="float">2.0</span>, -<span class="local-variable">this</span>.fraczoom)
                        )
                        <span class="keyword">var</span> latlongoffset = geo.metersToLatLng(metoffset[<span class="integer">0</span>], metoffset[<span class="integer">1</span>])
                        <span class="local-variable">this</span>.dataset.setCenterLatLng(
                                <span class="local-variable">this</span>.dataset.latlong[<span class="integer">0</span>] - latlongoffset[<span class="integer">0</span>],
                                <span class="local-variable">this</span>.dataset.latlong[<span class="integer">1</span>] - latlongoffset[<span class="integer">1</span>],
                                <span class="local-variable">this</span>.dataset.zoomlevel)
                        <span class="local-variable">this</span>.updateTiles()
                }
        }

        <span class="local-variable">this</span>.<span class="function">onpointerend</span> = <span class="keyword">function</span>(ev) {
                <span class="local-variable">this</span>.dragging = <span class="predefined-constant">false</span>
                <span class="local-variable">this</span>.emitUpward(<span class="string"><span class="delimiter">'</span><span class="content">latlongchange</span><span class="delimiter">'</span></span>, [<span class="local-variable">this</span>.latlong[<span class="integer">0</span>], <span class="local-variable">this</span>.latlong[<span class="integer">1</span>], <span class="local-variable">this</span>.zoomlevel])
        }

        <span class="local-variable">this</span>.<span class="function">onpointertap</span> = <span class="keyword">function</span>(ev) {
                <span class="keyword">var</span> coord  =  <span class="local-variable">this</span>.globalToLocal(ev.position)
                <span class="keyword">var</span> R = <span class="local-variable">this</span>.projectonplane(coord)
                <span class="keyword">if</span> (R) {
                        <span class="keyword">var</span> centermeters = geo.latLngToMeters(<span class="local-variable">this</span>.dataset.latlong[<span class="integer">0</span>], <span class="local-variable">this</span>.dataset.latlong[<span class="integer">1</span>])
                        <span class="keyword">var</span> zoomoffs = <span class="integer">0</span>
                        <span class="keyword">if</span> (ev.clicker == <span class="integer">2</span>) zoomoffs ++
                        <span class="comment">// convert GL unit to map meters</span>
                        <span class="keyword">var</span> r0 = (R[<span class="integer">0</span>] / (BufferGen.TileSize * <span class="integer">16</span>)) * geo.metersPerTile(<span class="local-variable">this</span>.zoomlevel) * Math.pow(<span class="float">2.0</span>, -<span class="local-variable">this</span>.fraczoom)
                        <span class="keyword">var</span> r2 = (-R[<span class="integer">2</span>] / (BufferGen.TileSize * <span class="integer">16</span>)) * geo.metersPerTile(<span class="local-variable">this</span>.zoomlevel) * Math.pow(<span class="float">2.0</span>, -<span class="local-variable">this</span>.fraczoom)
                        <span class="comment">//        var M = this.find('MARKER')</span>
                        <span class="keyword">var</span> latlong = geo.metersToLatLng(centermeters[<span class="integer">0</span>] + r0, centermeters[<span class="integer">1</span>] + r2)
                        <span class="local-variable">this</span>.dataset.setCenterLatLng(latlong[<span class="integer">0</span>], latlong[<span class="integer">1</span>] , <span class="local-variable">this</span>.dataset.zoomlevel + zoomoffs, <span class="integer">1</span>)
                        <span class="local-variable">this</span>.emitUpward(<span class="string"><span class="delimiter">'</span><span class="content">latlongchange</span><span class="delimiter">'</span></span>, [latlong[<span class="integer">0</span>], latlong[<span class="integer">1</span>], <span class="local-variable">this</span>.zoomlevel])
                }
        }

        <span class="local-variable">this</span>.<span class="function">gotoCity</span> = <span class="keyword">function</span>(city, zoomlevel, time) {
                <span class="local-variable">this</span>.dataset.gotoCity(city, zoomlevel, time)
        }

        <span class="local-variable">this</span>.<span class="function">flyTo</span> = <span class="keyword">function</span>(lat, lng, zoom, time) {
                <span class="keyword">if</span> (<span class="local-variable">this</span>.dataset) <span class="local-variable">this</span>.dataset.flyTo(lat, lng, zoom, time)
        }

        <span class="local-variable">this</span>.<span class="function">framePoints</span> = <span class="keyword">function</span>(points, time) {
                <span class="keyword">if</span> (<span class="local-variable">this</span>.dataset) <span class="local-variable">this</span>.dataset.framePoints(points, time)
        }

        <span class="comment">// data interaction, needs to inherit from view because of animation</span>
        define.<span class="reserved">class</span>(<span class="local-variable">this</span>, <span class="string"><span class="delimiter">'</span><span class="content">mapdataset</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">$ui/view</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(<span class="predefined">$$</span>, geo) {

                <span class="local-variable">this</span>.requestPending = <span class="predefined-constant">false</span>
                <span class="comment">// all the blocks that need to be loaded (empty tile objects)</span>
                <span class="local-variable">this</span>.loadqueue = []
                <span class="comment">// see if a block is in the queue (array of hashes)</span>
                <span class="local-variable">this</span>.loadqueuehash = []
                <span class="comment">// hash of tile objects (simple objects containing all the geometry)</span>
                <span class="local-variable">this</span>.loadedblocks = {}
                <span class="comment">// geo library</span>
                <span class="keyword">var</span> geo = <span class="local-variable">this</span>.geo = geo()

                <span class="local-variable">this</span>.attributes = {
                        <span class="comment">// cent</span>
                        <span class="key">centerpos</span>: vec2(<span class="integer">0</span>, <span class="integer">0</span>),
                        <span class="comment">// position of the map</span>
                        <span class="key">latlong</span>: vec2(<span class="integer">0</span>, <span class="integer">0</span>),
                        <span class="comment">// tile zoom level</span>
                        <span class="key">zoomlevel</span>: <span class="integer">16</span>,
                        <span class="comment">// amount of blocks in the cache</span>
                        <span class="key">throwawaythreshold</span>: <span class="integer">100</span>,
                }

                <span class="comment">// animatedly fly to a lat/long/zoom position in time with fly bounce (zoom level switching)</span>
                <span class="local-variable">this</span>.<span class="function">flyTo</span> = <span class="keyword">function</span>(lat, lng, zoom, time) {
                        time = time ? time : <span class="integer">0</span>
                        <span class="keyword">if</span> (zoom &gt; geo.default_max_zoom) zoom = geo.default_max_zoom

                        <span class="keyword">if</span> (time &gt; <span class="integer">0</span>) {
                                <span class="keyword">var</span> anim = {}
                                anim[time] = {<span class="key">motion</span>: <span class="string"><span class="delimiter">'</span><span class="content">inoutquad</span><span class="delimiter">'</span></span>, <span class="key">value</span>: vec2(lat, lng)}
                                <span class="local-variable">this</span>.latlong = Animate(anim)
                                <span class="keyword">var</span> anim = {}
                                <span class="comment">// anim[time / 2] = {motion: 'inoutquad', value: Math.min(zoom - 0.5, this.zoomlevel - 0.5)}</span>
                                anim[time] = {<span class="key">motion</span>: <span class="string"><span class="delimiter">'</span><span class="content">inoutquad</span><span class="delimiter">'</span></span>, <span class="key">value</span>: zoom}
                                <span class="local-variable">this</span>.zoomlevel = Animate(anim)
                        } <span class="keyword">else</span> {
                                <span class="local-variable">this</span>.zoomlevel = zoom
                                <span class="local-variable">this</span>.latlong = vec2(lat, lng)
                        }
                }


                <span class="local-variable">this</span>.<span class="function">framePoints</span> = <span class="keyword">function</span>(pointdata, time) {
                        sum = vec2(<span class="integer">0</span>, <span class="integer">0</span>)
                        maxpos = vec2(-<span class="predefined-constant">Infinity</span>, -<span class="predefined-constant">Infinity</span>)
                        minpos = vec2(<span class="predefined-constant">Infinity</span>, <span class="predefined-constant">Infinity</span>)
                        <span class="comment">// TODO: lan/lng is swapped. Fix map.js</span>
                        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; pointdata.length; i ++){
                                sum[<span class="integer">1</span>] = sum[<span class="integer">1</span>] + pointdata[i].latitude
                                sum[<span class="integer">0</span>] = sum[<span class="integer">0</span>] + pointdata[i].longitude
                                maxpos[<span class="integer">1</span>] = max(maxpos[<span class="integer">1</span>], pointdata[i].latitude)
                                maxpos[<span class="integer">0</span>] = max(maxpos[<span class="integer">0</span>], pointdata[i].longitude)
                                minpos[<span class="integer">1</span>] = min(minpos[<span class="integer">1</span>], pointdata[i].latitude)
                                minpos[<span class="integer">0</span>] = min(minpos[<span class="integer">0</span>], pointdata[i].longitude)
                        }
                        maxpos = geo.latLngToMeters(maxpos[<span class="integer">0</span>], maxpos[<span class="integer">1</span>])
                        minpos = geo.latLngToMeters(minpos[<span class="integer">0</span>], minpos[<span class="integer">1</span>])
                        <span class="keyword">var</span> distance = vec2.distance(maxpos, minpos)
                        <span class="keyword">var</span> zoom = geo.default_max_zoom
                        <span class="comment">// TODO: make frustum aware zoom level estimation</span>
                        <span class="keyword">if</span> (distance &lt; <span class="integer">312</span>) zoom = <span class="integer">15</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">625</span>) zoom = <span class="integer">14</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">1250</span>) zoom = <span class="integer">13</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">2500</span>) zoom = <span class="integer">12</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">5000</span>) zoom = <span class="integer">11</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">10000</span>) zoom = <span class="integer">10</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">20000</span>) zoom = <span class="integer">10</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">40000</span>) zoom = <span class="integer">9</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">80000</span>) zoom = <span class="integer">8</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">160000</span>) zoom = <span class="integer">7</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">320000</span>) zoom = <span class="integer">6</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">640000</span>) zoom = <span class="integer">5</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">128000</span>) zoom = <span class="integer">4</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">256000</span>) zoom = <span class="integer">3</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">512000</span>) zoom = <span class="integer">2</span>
                        <span class="keyword">else</span> <span class="keyword">if</span> (distance &lt; <span class="integer">1024000</span>) zoom = <span class="integer">1</span>
                        <span class="local-variable">this</span>.flyTo(sum[<span class="integer">0</span>] / pointdata.length, sum[<span class="integer">1</span>] / pointdata.length, zoom, time)
                }

                <span class="comment">// animatedly fly to lat/long without fly-bouncing</span>
                <span class="local-variable">this</span>.<span class="function">setCenterLatLng</span> = <span class="keyword">function</span>(lat, lng, zoom, time) {
                        time = time ? time : <span class="integer">0</span>
                        <span class="keyword">if</span> (zoom &gt; geo.default_max_zoom) zoom = geo.default_max_zoom
                        <span class="keyword">if</span> (time &gt; <span class="integer">0</span>) {
                                <span class="keyword">var</span> anim = {}
                                anim[time] = {<span class="key">motion</span>: <span class="string"><span class="delimiter">'</span><span class="content">inoutquad</span><span class="delimiter">'</span></span>, <span class="key">value</span>: vec2(lat,lng)}
                                <span class="local-variable">this</span>.latlong = Animate(anim)
                        } <span class="keyword">else</span> {
                                <span class="local-variable">this</span>.latlong = vec2(lat,lng)
                        }
                        <span class="local-variable">this</span>.zoomTo(zoom, time)
                }

                <span class="comment">// if zoomlevel changes update tiles</span>
                <span class="local-variable">this</span>.<span class="function">onzoomlevel</span> = <span class="keyword">function</span>() {
                        <span class="keyword">if</span> (<span class="local-variable">this</span>.parent) {
                                <span class="local-variable">this</span>.parent.updateTiles()
                        }
                }

                <span class="comment">// latlong changes, for all zoomlevels calculate tile centers</span>
                <span class="local-variable">this</span>.<span class="function">onlatlong</span> = <span class="keyword">function</span>() {
                        <span class="keyword">if</span>(!<span class="local-variable">this</span>.latlong) <span class="keyword">return</span>
                        <span class="local-variable">this</span>.parent.latlong = <span class="local-variable">this</span>.latlong
                        <span class="keyword">var</span> m = geo.latLngToMeters(<span class="local-variable">this</span>.latlong[<span class="integer">0</span>], <span class="local-variable">this</span>.latlong[<span class="integer">1</span>])
                        m[<span class="integer">0</span>] = Math.round(m[<span class="integer">0</span>])
                        m[<span class="integer">1</span>] = Math.round(m[<span class="integer">1</span>])
                        <span class="keyword">var</span> basecenter = geo.tileForMeters(m[<span class="integer">0</span>], m[<span class="integer">1</span>], <span class="integer">20</span>)
                        <span class="keyword">var</span> compmeters = geo.metersForTile({<span class="key">x</span>: basecenter[<span class="integer">0</span>],<span class="key">y</span>: basecenter[<span class="integer">1</span>], <span class="key">z</span>: <span class="integer">20</span>})

                        <span class="keyword">var</span> centerset = []
                        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; <span class="integer">20</span>; i ++) {
                                <span class="keyword">var</span> center = geo.tileForMeters(m[<span class="integer">0</span>], m[<span class="integer">1</span>], i)
                                centerset.push([center.x, center.y])
                        }
                        <span class="local-variable">this</span>.centers = centerset
                }

                <span class="comment">// zoom to animatedly zooms to a certain zoom</span>
                <span class="local-variable">this</span>.<span class="function">zoomTo</span> = <span class="keyword">function</span>(newz, time) {
                        <span class="keyword">if</span> (newz &gt; geo.default_max_zoom) newz = geo.default_max_zoom

                        time = time? time : <span class="integer">0</span>
                        <span class="keyword">if</span> (time &gt; <span class="integer">0</span>) {
                                <span class="keyword">var</span> anim = {}
                                anim[time] = {<span class="key">motion</span>: <span class="string"><span class="delimiter">'</span><span class="content">inoutquad</span><span class="delimiter">'</span></span>, <span class="key">value</span>: newz}
                                <span class="local-variable">this</span>.zoomlevel = Animate(anim)
                        } <span class="keyword">else</span> {
                                <span class="local-variable">this</span>.zoomlevel = newz
                        }
                }

                <span class="comment">// set the center in tile position x/y/zoom, uses to setCenterLatLng</span>
                <span class="local-variable">this</span>.<span class="function">setCenter</span> = <span class="keyword">function</span>(x,y,z, time) {
                        <span class="keyword">var</span> m = geo.metersForTile({<span class="key">x</span>: x, <span class="key">y</span>: y, <span class="key">z</span>: z})
                        <span class="keyword">var</span> ll = geo.metersToLatLng(m.x,m.y)
                        <span class="local-variable">this</span>.setCenterLatLng(ll[<span class="integer">0</span>], ll[<span class="integer">1</span>], time)
                        <span class="local-variable">this</span>.zoomTo(z, time)
                }

                <span class="comment">// queues up a block for loading at x,y,z</span>
                <span class="local-variable">this</span>.<span class="function">addToQueue</span> = <span class="keyword">function</span>(x, y, z) {
                        <span class="keyword">if</span> (x &lt; <span class="integer">0</span> || y &lt; <span class="integer">0</span> || z&lt; <span class="integer">0</span> || z&gt;geo.default_max_zoom) <span class="keyword">return</span>
                        <span class="keyword">var</span> hash = createHash(x, y, z)
                        <span class="keyword">if</span> (<span class="local-variable">this</span>.loadqueuehash[hash]) <span class="keyword">return</span>; <span class="comment">// already queued for load.</span>
                        <span class="keyword">if</span> (<span class="local-variable">this</span>.loadedblocks[hash]) <span class="keyword">return</span>; <span class="comment">// already loaded.</span>

                        <span class="local-variable">this</span>.loadqueuehash[hash] = <span class="integer">1</span>
                        <span class="local-variable">this</span>.loadqueue.push({<span class="key">x</span>: x, <span class="key">y</span>: y, <span class="key">z</span>: z})
                        <span class="local-variable">this</span>.updateLoadQueue()
                }

                <span class="comment">// Stores a loaded block into the loadedblocks structure</span>
                <span class="local-variable">this</span>.<span class="function">processLoadedBlock</span> = <span class="keyword">function</span>(x, y, z, data) {
                        <span class="keyword">var</span> hash = createHash(x,y,z)
                        <span class="local-variable">this</span>.loadedblocks[hash] = {<span class="key">x</span>: x, <span class="key">y</span>: y, <span class="key">z</span>: z, <span class="key">blockdata</span>: data}
                }

                <span class="comment">// prunes the loadedblocks to live below throwawaythreshold</span>
                <span class="local-variable">this</span>.<span class="function">cleanLoadedBlocks</span> = <span class="keyword">function</span>() {
                        <span class="keyword">var</span> keys = Object.keys(<span class="local-variable">this</span>.loadedblocks)
                        <span class="keyword">if</span> (keys.length &lt; <span class="local-variable">this</span>.throwawaythreshold) <span class="keyword">return</span>

                        <span class="keyword">var</span> zscalar = <span class="integer">1280</span>

                        <span class="keyword">var</span> dellist = []
                        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; keys.length; i ++) {
                                        <span class="keyword">var</span> q = <span class="local-variable">this</span>.loadedblocks[keys[i]]
                                        <span class="keyword">var</span> dx = <span class="local-variable">this</span>.centers[q.z][<span class="integer">0</span>] - q.x
                                        <span class="keyword">var</span> dy = <span class="local-variable">this</span>.centers[q.z][<span class="integer">1</span>] - q.y

                                        <span class="keyword">var</span> dz = (<span class="integer">20</span>-q.z) * zscalar
                                        <span class="keyword">var</span> dist = (dx * dx + dy * dy) * (<span class="integer">50000</span> - dz)
                                        dellist.push({<span class="key">hash</span>: keys[i], <span class="key">dist</span>: dist})

                                }

                                dellist = dellist.sort(<span class="keyword">function</span>(a, b) {
                                        <span class="keyword">if</span> (a.dist &gt; b.dist) <span class="keyword">return</span> <span class="integer">1</span>
                                        <span class="keyword">if</span> (a.dist &lt; b.dist) <span class="keyword">return</span> -<span class="integer">1</span>
                                        <span class="keyword">return</span> <span class="integer">0</span>
                                })

                        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="local-variable">this</span>.throwawaythreshold; i &lt; dellist.length; i ++) {
                                <span class="keyword">var</span> todelete = dellist[i]
                                <span class="keyword">var</span> blk = <span class="local-variable">this</span>.loadedblocks[todelete.hash]
                                <span class="keyword">delete</span> <span class="local-variable">this</span>.loadedblocks[todelete.hash]
                                <span class="keyword">if</span> (blk.buildingVertexBuffer) {
                                        <span class="keyword">if</span> (blk.buildingVertexBuffer.glvb) {
                                                <span class="local-variable">this</span>.screen.device.gl.deleteBuffer(blk.buildingVertexBuffer.glvb)
                                                blk.buildingVertexBuffer.glvb = <span class="predefined-constant">undefined</span>
                                        }
                                        <span class="keyword">if</span> (blk.landVertexBuffer.glvb) {
                                                <span class="local-variable">this</span>.screen.device.gl.deleteBuffer(blk.landVertexBuffer.glvb)
                                                blk.landVertexBuffer.glvb = <span class="predefined-constant">undefined</span>
                                        }
                                        <span class="keyword">if</span> (blk.roadVertexBuffer.glvb) {
                                                <span class="local-variable">this</span>.screen.device.gl.deleteBuffer(blk.roadVertexBuffer.glvb)
                                                blk.roadVertexBuffer.glvb = <span class="predefined-constant">undefined</span>
                                        }
                                }
                        }
                }

                <span class="comment">// the geometry generation worker</span>
                <span class="keyword">var</span> worker = define.<span class="reserved">class</span>(<span class="string"><span class="delimiter">'</span><span class="content">$system/rpc/worker</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(require) {
                        <span class="local-variable">this</span>.BufferGen = require(<span class="string"><span class="delimiter">'</span><span class="content">$widgets/map/mapbuffers</span><span class="delimiter">'</span></span>)()

                        <span class="local-variable">this</span>.<span class="function">build</span> = <span class="keyword">function</span>(str, r) {
                                <span class="keyword">var</span> ret = vec2.array(<span class="integer">10</span>)

                                <span class="keyword">try</span>{
                                        <span class="keyword">var</span> thedata = JSON.parse(str)
                                        <span class="local-variable">this</span>.BufferGen.build(r, thedata)
                                }
                                <span class="keyword">catch</span>(e) {
                                        console.log(e)
                                        console.log(<span class="string"><span class="delimiter">'</span><span class="content"> while loading </span><span class="delimiter">'</span></span>, r.x, r.y, r.z)
                                        r.transform = {<span class="key">translate</span>: {<span class="key">x</span>: <span class="integer">0</span>, <span class="key">y</span>: <span class="integer">0</span>}}
                                }
                                <span class="keyword">return</span> r
                        }
                })

                <span class="comment">// loads a json string tile and sends it off to the worker</span>
                <span class="local-variable">this</span>.<span class="function">loadstring</span> = <span class="keyword">function</span>(str) {
                        <span class="comment">// if (!window.teller) window.teller = 0</span>
                        <span class="comment">// window.teller += str.length</span>

                        <span class="keyword">if</span> (<span class="local-variable">this</span>.currentRequest) {

                                <span class="keyword">var</span> r = <span class="local-variable">this</span>.currentRequest
                                <span class="keyword">var</span> hash = createHash(r.x, r.y, r.z)
                                r.hash = hash

                                <span class="local-variable">this</span>.workers.build(str, r).then(<span class="keyword">function</span>(result) {
                                        <span class="keyword">if</span> (!result) <span class="keyword">return</span>
                                        <span class="keyword">var</span> dt = Date.now()
                                        <span class="local-variable">this</span>.loadedblocks[r.hash] = result.value
                                        <span class="local-variable">this</span>.loadqueuehash[r.hash] = <span class="predefined-constant">undefined</span>
                                        <span class="local-variable">this</span>.parent.redraw()<span class="comment">//updateTiles()</span>
                                }.bind(<span class="local-variable">this</span>))

                                <span class="local-variable">this</span>.currentRequest = <span class="predefined-constant">undefined</span>
                                <span class="local-variable">this</span>.cleanLoadedBlocks()
                                <span class="local-variable">this</span>.updateLoadQueue()
                        }
                }

                <span class="comment">// returns a block by hash</span>
                <span class="local-variable">this</span>.<span class="function">getBlockByHash</span> = <span class="keyword">function</span>(hash) {
                        <span class="keyword">return</span> <span class="local-variable">this</span>.loadedblocks[hash]
                }

                <span class="comment">// Check if there are tiles in the queue and loads the next one via RPC</span>
                <span class="local-variable">this</span>.<span class="function">updateLoadQueue</span> = <span class="keyword">function</span>() {

                        <span class="keyword">if</span> (<span class="local-variable">this</span>.currentRequest) <span class="keyword">return</span>; <span class="comment">// already loading something...</span>
                        <span class="keyword">if</span> (<span class="local-variable">this</span>.loadqueue.length &gt; <span class="integer">0</span>) {

                                <span class="keyword">var</span> zscalar = <span class="integer">1280</span>

                                <span class="comment">// sort queue on distance to cursor</span>
                                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; <span class="local-variable">this</span>.loadqueue.length; i ++) {
                                        <span class="keyword">var</span> q = <span class="local-variable">this</span>.loadqueue[i]
                                        <span class="keyword">var</span> dx = <span class="local-variable">this</span>.centers[q.z][<span class="integer">0</span>] - q.x
                                        <span class="keyword">var</span> dy = <span class="local-variable">this</span>.centers[q.z][<span class="integer">1</span>] - q.y

                                        <span class="keyword">var</span> dz = (<span class="integer">20</span>-q.z) * zscalar
                                        q.dist = (dx * dx + dy * dy) * (<span class="integer">50000</span> - dz)
                                }

                                <span class="local-variable">this</span>.loadqueue = <span class="local-variable">this</span>.loadqueue.sort(<span class="keyword">function</span>(a,b) {
                                        <span class="keyword">if</span> (a.dist &gt; b.dist) <span class="keyword">return</span> -<span class="integer">1</span>
                                        <span class="keyword">if</span> (a.dist &lt; b.dist) <span class="keyword">return</span> <span class="integer">1</span>
                                        <span class="keyword">return</span> <span class="integer">0</span>
                                })

                                <span class="keyword">var</span> R =        <span class="local-variable">this</span>.currentRequest = <span class="local-variable">this</span>.loadqueue.pop()
                                <span class="local-variable">this</span>.rpc.urlfetch.grabmap(R.x, R.y, R.z).then(<span class="keyword">function</span>(result) {
                                        <span class="local-variable">this</span>.loadstring(result.value)
                                }.bind(<span class="local-variable">this</span>))

                                <span class="comment">// take closest one from the queue</span>
                        }
                }

                <span class="local-variable">this</span>.<span class="function">destroy</span> = <span class="keyword">function</span>() {
                        <span class="local-variable">this</span>.clearInterval(<span class="local-variable">this</span>.theinterval)
                }

                <span class="comment">// looks up a city by latlong in city dictionary</span>
                <span class="local-variable">this</span>.<span class="function">gotoCity</span> = <span class="keyword">function</span>(name, zoom, time) {
                        <span class="keyword">if</span> (!name || name.length == <span class="integer">0</span>) <span class="keyword">return</span>
                        <span class="keyword">var</span> n2 = name.toLowerCase().replace(<span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)

                        <span class="keyword">var</span> c = <span class="local-variable">this</span>.cities[n2]
                        <span class="keyword">if</span> (c) {
                                <span class="local-variable">this</span>.setCenterLatLng(c[<span class="integer">1</span>], c[<span class="integer">0</span>], zoom,time)
                        } <span class="keyword">else</span> {
                                console.log(<span class="string"><span class="delimiter">'</span><span class="content">city not found: </span><span class="delimiter">'</span></span>, name)
                        }
                }

                <span class="local-variable">this</span>.<span class="function">init</span> = <span class="keyword">function</span>(prev) {
                        <span class="local-variable">this</span>.centers = []

                        <span class="local-variable">this</span>.workers = prev &amp;&amp; prev.workers || worker(<span class="integer">0</span>)
                        <span class="comment">// lookup table of cities</span>
                        <span class="local-variable">this</span>.cities = {
                                <span class="key">manhattan</span>: [<span class="float">40.7072121</span>, -<span class="float">74.0067985</span>],
                                <span class="key">amsterdam</span>: [<span class="float">52.3608307</span>,   <span class="float">4.8626387</span>],
                                <span class="key">sanfrancisco</span>: [<span class="float">37.6509102</span>, -<span class="float">122.4889338</span>],
                                <span class="key">sanfrancisco_goldengatepark</span>: [<span class="float">37.7677892</span>, -<span class="float">122.4853213</span>],
                                <span class="key">seoul</span>: [<span class="float">37.5275421</span>, <span class="float">126.9748078</span>],
                                <span class="key">seoel</span>: [<span class="float">37.5275421</span>, <span class="float">126.9748078</span>],
                                <span class="key">shenzhen_hqb</span>: [<span class="float">22.5402897</span>, <span class="float">114.0846914</span>],
                                <span class="key">hongkong</span>: [<span class="float">22.2854084</span>, <span class="float">114.1600463</span>],
                                <span class="key">sydney</span>: [-<span class="float">33.8466226</span>, <span class="float">151.2277997</span>],
                                <span class="key">london</span>: [<span class="float">51.5091502</span>, -<span class="float">0.1471011</span>],
                                <span class="key">texel</span>: [<span class="float">53.0731212</span>,<span class="float">4.712878</span>]
                        }

                        <span class="local-variable">this</span>.gotoCity(<span class="string"><span class="delimiter">'</span><span class="content">manhattan</span><span class="delimiter">'</span></span>, <span class="integer">13</span>)

                        <span class="comment">// interval to poll the loadqueue</span>
                        <span class="comment">//!TODO maybe remove</span>
                        <span class="local-variable">this</span>.theinterval = <span class="local-variable">this</span>.setInterval(<span class="keyword">function</span>() {
                                <span class="local-variable">this</span>.updateLoadQueue()
                        }.bind(<span class="local-variable">this</span>), <span class="integer">100</span>)

                        <span class="local-variable">this</span>.rpc.urlfetch.sessionstart()
                        <span class="comment">//this.setCenter(33656/2,21534/2, 16)</span>
                }
        })

        <span class="comment">// Every time we re-draw process the</span>
        <span class="local-variable">this</span>.<span class="function">atAnimate</span> = <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.updateTiles()
        }

        <span class="comment">// make a new dataset and updatetiles</span>
        <span class="local-variable">this</span>.<span class="function">oninit</span> = <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.dataset = <span class="local-variable">this</span>.mapdataset({<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">mapdata</span><span class="delimiter">'</span></span>})
                <span class="comment">//!TODO odd redraw might miss? please remove</span>
                <span class="local-variable">this</span>.setInterval(<span class="local-variable">this</span>.updateTiles, <span class="integer">1000</span>)
        }

        <span class="comment">// Unproject camera to XYZ (see GLU Unproject)</span>
        <span class="keyword">function</span> <span class="function">UnProject</span>(glx, gly, glz, modelview, projection) {
                <span class="keyword">var</span> inv = vec4()
                <span class="keyword">var</span> A = mat4.mat4_mul_mat4(modelview, projection)
                <span class="keyword">var</span> m = mat4.invert(A)
                inv[<span class="integer">0</span>] = glx
                inv[<span class="integer">1</span>] = gly
                inv[<span class="integer">2</span>] = <span class="float">2.0</span> * glz - <span class="float">1.0</span>
                inv[<span class="integer">3</span>] = <span class="float">1.0</span>
                out = vec4.vec4_mul_mat4(inv, m)
                <span class="comment">// divide by W to perform perspective!</span>
                out[<span class="integer">0</span>] /= out[<span class="integer">3</span>]
                out[<span class="integer">1</span>] /= out[<span class="integer">3</span>]
                out[<span class="integer">2</span>] /= out[<span class="integer">3</span>]
                <span class="keyword">return</span> vec3(out)
        }

        <span class="comment">// Project a mousecoord to map plane decoding (in, mouse, out, GL units)</span>
        <span class="local-variable">this</span>.<span class="function">projectonplane</span> = <span class="keyword">function</span>(coord) {
                <span class="keyword">var</span> vp = <span class="local-variable">this</span>.find(<span class="string"><span class="delimiter">'</span><span class="content">mapinside</span><span class="delimiter">'</span></span>)
                <span class="keyword">if</span> (!vp) <span class="keyword">return</span>

                <span class="keyword">var</span> sx = vp.layout.width
                <span class="keyword">var</span> sy = vp.layout.height


                <span class="keyword">var</span> mx = (coord[<span class="integer">0</span>] / (sx / <span class="integer">2</span>)) - <span class="float">1.0</span>
                <span class="keyword">var</span> my =  (coord[<span class="integer">1</span>] / (sy / <span class="integer">2</span>)) - <span class="float">1.0</span>

                <span class="keyword">var</span> view = vp.colormatrices.lookatmatrix
                <span class="keyword">var</span> invview = mat4.identity()
                mat4.invert(view, invview)

                <span class="keyword">var</span> aspect = vp.layout.width/vp.layout.height
                <span class="keyword">var</span> nearheight = Math.tan((vp.fov/<span class="integer">2</span>) * ((Math.PI * <span class="integer">2</span>)/<span class="float">360.0</span>)) * vp.nearplane
                <span class="keyword">var</span> nearwidth = nearheight * aspect
                <span class="keyword">var</span> zeropos = vec4(<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="float">1.0</span>)
                <span class="keyword">var</span> camerainview = vec4(mx * nearwidth,my * nearheight, -vp.nearplane, <span class="float">0.0</span>)
                <span class="keyword">var</span> zeroworld = vec4.mul_mat4(zeropos, invview)
                <span class="keyword">var</span> cameraworld = vec4.mul_mat4(camerainview, invview)
                <span class="keyword">var</span> end = vec3(zeroworld[<span class="integer">0</span>] + cameraworld[<span class="integer">0</span>] * <span class="integer">1000</span>, zeroworld[<span class="integer">1</span>] + cameraworld[<span class="integer">1</span>] * <span class="integer">1000</span>, zeroworld[<span class="integer">2</span>] + cameraworld[<span class="integer">2</span>] * <span class="integer">1000</span>)

                <span class="keyword">var</span> R = vec3.intersectplane(zeroworld, end, vec3(<span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>), <span class="integer">0</span>)
                <span class="keyword">if</span> (!R) <span class="keyword">return</span> <span class="predefined-constant">null</span>

                <span class="keyword">var</span> M = <span class="local-variable">this</span>.find(<span class="string"><span class="delimiter">'</span><span class="content">MARKER</span><span class="delimiter">'</span></span>)
                <span class="keyword">if</span> (M) {
                        M.pos = vec3(R[<span class="integer">0</span>],R[<span class="integer">1</span>]-M.fontsize,R[<span class="integer">2</span>])
                        M.text =(Math.round(M.pos[<span class="integer">0</span>] * <span class="integer">100</span>)/<span class="integer">100</span>) + <span class="string"><span class="delimiter">'</span><span class="content">, </span><span class="delimiter">'</span></span> +  (Math.round(M.pos[<span class="integer">2</span>] * <span class="integer">100</span>)/<span class="integer">100</span>)
                }
                <span class="keyword">return</span> R
        }

        <span class="comment">// debug tile counter</span>
        <span class="keyword">var</span> alltiles = <span class="integer">0</span>

        <span class="comment">// All tiles use tilebasemixin</span>
        <span class="keyword">var</span> tilebasemixin = define.<span class="reserved">class</span>(Object, <span class="keyword">function</span>() {

                <span class="local-variable">this</span>.drawtarget = <span class="string"><span class="delimiter">'</span><span class="content">color</span><span class="delimiter">'</span></span>

                <span class="local-variable">this</span>.attributes = {
                        <span class="comment">// the translate in integer units</span>
                        <span class="key">trans</span>: vec2(<span class="integer">0</span>),
                        <span class="comment">// the coordinate in integer units</span>
                        <span class="key">coord</span>: vec2(<span class="integer">0</span>),
                        <span class="comment">// center coordinate in mercatormeters</span>
                        <span class="key">centerpos</span>: vec2(<span class="integer">4</span>,<span class="integer">3</span>),
                        <span class="comment">// zoomlevel of the tile</span>
                        <span class="key">zoomlevel</span>: <span class="integer">16</span>,
                        <span class="comment">// animation for bufferloaded</span>
                        <span class="key">bufferloaded</span>: <span class="float">0.0</span>,

                        <span class="comment">//tiletrans: vec2(0),</span>
                        <span class="comment">// fog color</span>
                        <span class="key">fog</span>: vec4(<span class="string"><span class="delimiter">'</span><span class="content">lightblue</span><span class="delimiter">'</span></span>),
                        <span class="comment">// fog start</span>
                        <span class="key">fogstart</span>: <span class="float">14000.0</span>,
                        <span class="comment">// fog end</span>
                        <span class="key">fogend</span>: <span class="integer">24000</span>.,
                        <span class="comment">// how many zoom levels away from basezoom</span>
                        <span class="key">layeroffset</span>: <span class="integer">0</span>,
                        <span class="comment">// thickness of the layer</span>
                        <span class="key">layerzmult</span>: <span class="integer">0</span>,
                        <span class="comment">// layer z offset</span>
                        <span class="key">layerzoff</span>: <span class="integer">0</span>,
                        <span class="comment">// how far inbetween two zoomlevels you are</span>
                        <span class="key">fraczoom</span>: <span class="float">0.5</span>,
                        <span class="comment">// center in mercatormeters</span>
                        <span class="key">centermeter</span>: vec2(<span class="integer">0</span>),
                        <span class="comment">// how many meters a tile spans</span>
                        <span class="key">meterspertile</span>: <span class="integer">1</span>
                }
                <span class="comment">// amount of frames it has waited since it got queued in the load</span>
                <span class="local-variable">this</span>.frameswaited = <span class="integer">0</span>
                <span class="comment">// not animated bufferloaded as boolean</span>
                <span class="local-variable">this</span>.bufferloadbool = <span class="predefined-constant">false</span>

                <span class="local-variable">this</span>.lastpos = vec2(<span class="integer">0</span>)

                <span class="comment">// return the tile position</span>
                <span class="local-variable">this</span>.<span class="function">calctilepos</span> = <span class="keyword">function</span>() {
                        <span class="keyword">var</span> x = Math.floor(<span class="local-variable">this</span>._coord[<span class="integer">0</span>] + <span class="local-variable">this</span>._trans[<span class="integer">0</span>])
                        <span class="keyword">var</span> y = Math.floor(<span class="local-variable">this</span>._coord[<span class="integer">1</span>] + <span class="local-variable">this</span>._trans[<span class="integer">1</span>])
                        <span class="keyword">return</span> [x,y, <span class="local-variable">this</span>._zoomlevel ]
                }

                <span class="local-variable">this</span>.<span class="function">init</span> = <span class="keyword">function</span>() {
                        <span class="keyword">var</span> R = <span class="local-variable">this</span>.calctilepos()
                        <span class="local-variable">this</span>.tilename = <span class="string"><span class="delimiter">'</span><span class="content">tile</span><span class="delimiter">'</span></span> + alltiles.toString() + <span class="string"><span class="delimiter">'</span><span class="content">_</span><span class="delimiter">'</span></span> + <span class="local-variable">this</span>.layeroffset
                        alltiles ++
                        <span class="local-variable">this</span>.lastpos = vec3(R[<span class="integer">0</span>], R[<span class="integer">1</span>], R[<span class="integer">2</span>])
                }

                <span class="comment">// sets the position informatio of the tile</span>
                <span class="local-variable">this</span>.<span class="function">setpos</span> = <span class="keyword">function</span>(newcoord, newzoom, frac, fraczoom, centermeter) {
                        <span class="local-variable">this</span>._tiletrans = frac
                        <span class="local-variable">this</span>._centermeter = centermeter
                        <span class="local-variable">this</span>._zoomlevel = newzoom
                        <span class="local-variable">this</span>._coord = vec2(Math.floor(newcoord.x), Math.floor(newcoord.y))
                        <span class="local-variable">this</span>._fraczoom = fraczoom
                        <span class="local-variable">this</span>.checknewpos()
                }

                <span class="comment">// calculate if the position changed since the last frame, used for tile buffer recycling</span>
                <span class="comment">// see if it should have a new vertexbuffer compared to last frame</span>
                <span class="local-variable">this</span>.<span class="function">checknewpos</span> = <span class="keyword">function</span>(thetime) {
                        <span class="keyword">var</span> R = <span class="local-variable">this</span>.calctilepos()
                        <span class="keyword">var</span> newpos =         vec3(R[<span class="integer">0</span>], R[<span class="integer">1</span>], R[<span class="integer">2</span>])
                        <span class="keyword">if</span> (<span class="local-variable">this</span>.lastpos[<span class="integer">0</span>] != newpos[<span class="integer">0</span>] || <span class="local-variable">this</span>.lastpos[<span class="integer">1</span>] != newpos[<span class="integer">1</span>] || <span class="local-variable">this</span>.lastpos[<span class="integer">2</span>] != newpos[<span class="integer">2</span>]) {
                                <span class="local-variable">this</span>.lastpos = newpos
                                <span class="local-variable">this</span>.tilehash = createHash(<span class="local-variable">this</span>.lastpos[<span class="integer">0</span>], <span class="local-variable">this</span>.lastpos[<span class="integer">1</span>], <span class="local-variable">this</span>.lastpos[<span class="integer">2</span>])
                                <span class="local-variable">this</span>.bufferloaded = <span class="integer">0</span>
                                <span class="local-variable">this</span>.frameswaited = <span class="integer">0</span>
                                <span class="local-variable">this</span>.bufferloadbool = <span class="predefined-constant">false</span>
                                <span class="local-variable">this</span>.queued  = <span class="integer">0</span>
                                <span class="local-variable">this</span>.redraw()
                                <span class="local-variable">this</span>.loadbuffer(thetime)
                        }<span class="keyword">else</span> {
                                <span class="keyword">if</span> (<span class="local-variable">this</span>.bufferloadbool == <span class="predefined-constant">false</span>) <span class="local-variable">this</span>.loadbuffer(thetime);<span class="keyword">else</span> <span class="local-variable">this</span>.bl.lasttime = thetime
                        }
                }

                <span class="comment">// loads the tile buffer, wraps around loadBufferFromTile</span>
                <span class="comment">// called in updateTiles</span>
                <span class="local-variable">this</span>.<span class="function">loadbuffer</span> = <span class="keyword">function</span>() {
                        md = <span class="local-variable">this</span>.mapdata
                        <span class="keyword">if</span> (md) {
                                <span class="local-variable">this</span>.bl = md.getBlockByHash(<span class="local-variable">this</span>.tilehash)
                                <span class="keyword">if</span> (<span class="local-variable">this</span>.bl) {
                                        <span class="keyword">if</span> (<span class="local-variable">this</span>.loadBufferFromTile(<span class="local-variable">this</span>.bl)) {

                                                <span class="keyword">if</span> (<span class="local-variable">this</span>.frameswaited == <span class="integer">0</span>) {
                                                        <span class="local-variable">this</span>.bufferloaded = <span class="float">1.0</span>
                                                } <span class="keyword">else</span> {
                                                        <span class="local-variable">this</span>.bufferloaded = Animate({<span class="integer">1</span>: {<span class="key">value</span>: <span class="float">1.0</span>, <span class="key">motion</span>: <span class="string"><span class="delimiter">'</span><span class="content">inoutquad</span><span class="delimiter">'</span></span>}})
                                                }
                                                <span class="local-variable">this</span>.bufferloadbool = <span class="predefined-constant">true</span>

                                                <span class="keyword">var</span> trans = <span class="local-variable">this</span>.bl.transform.translate
                                                <span class="keyword">var</span> mercmeter = geo.latLngToMeters(trans[<span class="integer">0</span>], trans[<span class="integer">1</span>])
                                                <span class="local-variable">this</span>.centerpos =vec2(mercmeter[<span class="integer">0</span>], mercmeter[<span class="integer">1</span>])
                                                <span class="local-variable">this</span>.redraw()
                                        }
                                }
                                <span class="keyword">else</span> {
                                        <span class="local-variable">this</span>.frameswaited ++
                                        <span class="keyword">if</span> (<span class="local-variable">this</span>.queued == <span class="integer">0</span>) {
                                                <span class="keyword">if</span> (<span class="local-variable">this</span>.shaders &amp;&amp; <span class="local-variable">this</span>.shaders.hardrect &amp;&amp; <span class="local-variable">this</span>.shaders.hardrect.update) <span class="local-variable">this</span>.shaders.hardrect.update()
                                                <span class="keyword">if</span> (<span class="local-variable">this</span>.resetbuffer) <span class="local-variable">this</span>.resetbuffer()
                                                md.addToQueue(<span class="local-variable">this</span>.lastpos[<span class="integer">0</span>], <span class="local-variable">this</span>.lastpos[<span class="integer">1</span>], <span class="local-variable">this</span>.lastpos[<span class="integer">2</span>])
                                                <span class="local-variable">this</span>.queued  = <span class="integer">1</span>
                                        }
                                }
                        }
                }

                <span class="local-variable">this</span>.tilesize = BufferGen.TileSize
                <span class="local-variable">this</span>.width = <span class="local-variable">this</span>.tilesize
                <span class="local-variable">this</span>.height = <span class="local-variable">this</span>.tilesize
        })

        <span class="comment">// view implementation of the building</span>
        define.<span class="reserved">class</span>(<span class="local-variable">this</span>, <span class="string"><span class="delimiter">'</span><span class="content">buildingtile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">$ui/view</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.is = tilebasemixin
                <span class="local-variable">this</span>.<span class="function">loadBufferFromTile</span> = <span class="keyword">function</span>(tile) {
                        <span class="keyword">if</span> (!<span class="local-variable">this</span>.shaders || !<span class="local-variable">this</span>.shaders.hardrect || !tile.buildingVertexBuffer) <span class="keyword">return</span> <span class="predefined-constant">false</span>
                        <span class="local-variable">this</span>.shaders.hardrect.mesh = tile.buildingVertexBuffer
                        <span class="local-variable">this</span>.shaders.hardrect.mesh.sticky = <span class="predefined-constant">true</span>

                        <span class="keyword">return</span> <span class="predefined-constant">true</span>
                }

                <span class="local-variable">this</span>.<span class="function">hardrect</span> = <span class="keyword">function</span>() {

                        <span class="local-variable">this</span>.<span class="function">position</span> = <span class="keyword">function</span>() {
                                <span class="comment">//idxpos = (view.trans.xy * vec2(1, -1)) * vec2(1, -1)</span>
                                pos = vec2(<span class="integer">1</span>, -<span class="integer">1</span>) * mesh.pos.xy;<span class="comment">// + (idxpos - view.tiletrans) * view.tilesize</span>
                                pos.xy -= ((((view.centerpos- view.centermeter)) / view.meterspertile) * <span class="float">1024.0</span>) * vec2(-<span class="float">1.0</span>, <span class="float">1.0</span>)
                                pos.xy /= pow(<span class="float">2.0</span>, view.layeroffset - view.fraczoom -<span class="integer">2</span>)
                                <span class="comment">//pos.xy *= view.meterspertile/view.tilesize</span>

                                respos = vec4(pos.x, -((mesh.pos.z * <span class="integer">1024</span>.)/(view.meterspertile / pow(<span class="float">2.0</span>, view.fraczoom))) * view.bufferloaded + view.layeroffset * view.layerzmult + view.layerzoff, pos.y, <span class="integer">1</span>) * view.totalmatrix * view.viewmatrix
                                <span class="comment">//r.w += 0.002</span>
                                <span class="keyword">return</span> respos
                        }

                        <span class="local-variable">this</span>.mesh =  BufferGen.BuildingVertexStruct.array()

                        <span class="local-variable">this</span>.<span class="function">update</span> = <span class="keyword">function</span>() {
                                <span class="local-variable">this</span>.mesh =  BufferGen.BuildingVertexStruct.array()
                        }

                        <span class="local-variable">this</span>.drawtype = <span class="local-variable">this</span>.TRIANGLES

                        <span class="local-variable">this</span>.<span class="function">color</span> = <span class="keyword">function</span>() {
                                <span class="keyword">var</span> noise = noise.cheapnoise(pos * <span class="float">0.02</span>) * <span class="float">0.1</span> + <span class="float">0.5</span>
                                <span class="keyword">var</span> prefog = mesh.color1
                                prefog.xyz *= <span class="float">0.6</span> + <span class="float">0.4</span> * max(<span class="float">0.0</span>, min(<span class="float">1.0</span>, ((mesh.pos.z - mesh.height) * <span class="float">0.001</span>) + <span class="float">0.4</span>))
                                <span class="keyword">var</span> zdist = max(<span class="integer">0</span>.,min(<span class="integer">1</span>.,(respos.z-view.fogstart)/view.fogend))
                                <span class="comment">//zdist *= zdist</span>
                                <span class="keyword">return</span> mix(prefog, view.fog, zdist)
                        }
                }
        })

        <span class="comment">// view implementation of the land</span>
        define.<span class="reserved">class</span>(<span class="local-variable">this</span>, <span class="string"><span class="delimiter">'</span><span class="content">landtile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">$ui/view</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {

                <span class="local-variable">this</span>.is = tilebasemixin

                <span class="local-variable">this</span>.<span class="function">loadBufferFromTile</span> = <span class="keyword">function</span>(tile) {
                        <span class="keyword">if</span> (!<span class="local-variable">this</span>.shaders || !<span class="local-variable">this</span>.shaders.hardrect || !tile.landVertexBuffer) <span class="keyword">return</span> <span class="predefined-constant">false</span>
                        <span class="local-variable">this</span>.shaders.hardrect.mesh = tile.landVertexBuffer
                        <span class="local-variable">this</span>.shaders.hardrect.mesh.sticky = <span class="predefined-constant">true</span>

                        <span class="keyword">return</span> <span class="predefined-constant">true</span>
                }
                <span class="local-variable">this</span>.pickalpha  = <span class="float">0.1</span>
                <span class="local-variable">this</span>.<span class="function">hardrect</span> = <span class="keyword">function</span>() {
                        <span class="local-variable">this</span>.texture = require(<span class="string"><span class="delimiter">'</span><span class="content">./mapmaterial.png</span><span class="delimiter">'</span></span>)
                        <span class="local-variable">this</span>.<span class="function">position</span> = <span class="keyword">function</span>() {
                                idxpos = (view.trans.xy * vec2(<span class="integer">1</span>, -<span class="integer">1</span>)) * vec2(<span class="integer">1</span>, -<span class="integer">1</span>)
                                pos = vec2(<span class="integer">1</span>, -<span class="integer">1</span>) * mesh.pos.xy;
                                pos.xy -= ((((view.centerpos- view.centermeter)) / view.meterspertile) * <span class="float">1024.0</span>) * vec2(-<span class="float">1.0</span>, <span class="float">1.0</span>)
                                pos.xy /= pow(<span class="float">2.0</span>, view.layeroffset - view.fraczoom -<span class="integer">2</span>)
                                respos = vec4(pos.x, view.layeroffset * view.layerzmult + view.layerzoff, pos.y, <span class="integer">1</span>) * view.totalmatrix * view.viewmatrix
                                <span class="keyword">return</span> respos
                        }

                        <span class="local-variable">this</span>.mesh =  BufferGen.LandVertexStruct.array()

                        <span class="local-variable">this</span>.<span class="function">update</span> = <span class="keyword">function</span>() {
                                <span class="local-variable">this</span>.mesh =  BufferGen.LandVertexStruct.array()
                                <span class="keyword">var</span> a = BufferGen.TileSize * <span class="float">0.05</span>
                                <span class="keyword">var</span> b = BufferGen.TileSize - a
                                <span class="keyword">var</span> col =  vec4(<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="float">0.2</span>)
                        }

                        <span class="local-variable">this</span>.drawtype = <span class="local-variable">this</span>.TRIANGLES
                        <span class="local-variable">this</span>.depth_test = <span class="string"><span class="delimiter">'</span><span class="content">disabled</span><span class="delimiter">'</span></span>

                        <span class="local-variable">this</span>.<span class="function">color</span> = <span class="keyword">function</span>() {
                                PickGuid = mesh.pos.z
                                <span class="keyword">var</span> noise = noise.cheapnoise(pos * <span class="float">0.02</span>) * <span class="float">0.07</span> + <span class="float">0.5</span>
                                <span class="keyword">var</span> texcol = mesh.color1
                                <span class="keyword">var</span> prefog = texcol
                                <span class="keyword">var</span> zdist = max(<span class="integer">0</span>.,min(<span class="integer">1</span>.,(respos.z-view.fogstart)/view.fogend))
                                zdist *= zdist
                                <span class="keyword">return</span> mix(prefog, view.fog, zdist)
                        }
                }
        })

        <span class="comment">// view implementation of the label tile</span>
        define.<span class="reserved">class</span>(<span class="local-variable">this</span>, <span class="string"><span class="delimiter">'</span><span class="content">labeltile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">$ui/labelset</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
                <span class="comment">//this.polygonoffset = 100.0</span>
                <span class="local-variable">this</span>.is = tilebasemixin
                <span class="local-variable">this</span>.fgcolor = <span class="string"><span class="delimiter">'</span><span class="content">black</span><span class="delimiter">'</span></span>
                <span class="local-variable">this</span>.font = ubuntufont

                <span class="local-variable">this</span>.<span class="function">textpositionfn</span> = <span class="keyword">function</span>(pos, tag) {
                <span class="comment">//        idxpos = (this.trans.xy * vec2(1, -1)) * vec2(1, -1)</span>
                }

                <span class="local-variable">this</span>.<span class="function">textstyle</span> = <span class="keyword">function</span>(style, tag) {
                        <span class="keyword">var</span> pos = style.pos
                        <span class="keyword">var</span> rpos = vec2(<span class="integer">1</span>, -<span class="integer">1</span>) * pos.xz
                        rpos.y += pos.y
                        rpos.xy -= ((((<span class="local-variable">this</span>.centerpos- <span class="local-variable">this</span>.centermeter)) / <span class="local-variable">this</span>.meterspertile) * <span class="float">1024.0</span>) * vec2(-<span class="float">1.0</span>, <span class="float">1.0</span>)
                        rpos.xy /= pow(<span class="float">2.0</span>, <span class="local-variable">this</span>.layeroffset - <span class="local-variable">this</span>.fraczoom - <span class="integer">2</span>)
                        style.pos = vec3(rpos.x, -<span class="integer">25</span> + <span class="local-variable">this</span>.layeroffset * <span class="local-variable">this</span>.layerzmult + <span class="local-variable">this</span>.layerzoff, rpos.y)
                        style.fgcolor = <span class="string"><span class="delimiter">'</span><span class="content">black</span><span class="delimiter">'</span></span>
                        <span class="comment">// style.outlinecolor = 'white'</span>
                        <span class="comment">// style.outlinethickness = 1.0</span>
                        <span class="comment">// style.outline = true</span>
                        <span class="keyword">return</span> style
                }

                <span class="local-variable">this</span>.<span class="function">resetbuffer</span> = <span class="keyword">function</span>() {
                        <span class="local-variable">this</span>.labels = []
                }

                <span class="local-variable">this</span>.<span class="function">loadBufferFromTile</span> = <span class="keyword">function</span>(tile) {
                        <span class="keyword">var</span> LabelSource = tile.Labels

                        <span class="keyword">if</span> (!LabelSource) {
                                <span class="local-variable">this</span>.labels = []
                                <span class="keyword">return</span>
                        }
                        <span class="keyword">var</span> thelabels = []
                        <span class="keyword">var</span> rankfontsizes = {
                                <span class="integer">0</span>: <span class="integer">60</span>,
                                <span class="integer">1</span>: <span class="integer">55</span>,
                                <span class="integer">2</span>: <span class="integer">50</span>,
                                <span class="integer">3</span>: <span class="integer">45</span>,
                                <span class="integer">4</span>: <span class="integer">40</span>,
                                <span class="integer">5</span>: -<span class="integer">1</span>,
                                <span class="integer">6</span>: -<span class="integer">1</span>,
                                <span class="integer">7</span>: -<span class="integer">1</span>
                        }

                        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; LabelSource.length; i ++) {
                                <span class="keyword">var</span> l = LabelSource[i]
                                <span class="keyword">var</span> f = <span class="integer">30</span>
                                <span class="keyword">if</span> (l.scalerank !== <span class="predefined-constant">undefined</span>) {
                                        f = rankfontsizes[l.scalerank] * Math.pow(<span class="integer">2</span>, <span class="local-variable">this</span>.layeroffset - <span class="integer">1</span>)
                                }

                                <span class="keyword">if</span> (f &gt; -<span class="integer">1</span>) {
                                        <span class="keyword">var</span> l2 = {<span class="key">text</span>: l.name, <span class="key">fontsize</span>: f,<span class="key">outline</span>: <span class="predefined-constant">false</span>, <span class="key">color</span>: vec4(<span class="string"><span class="delimiter">'</span><span class="content">white</span><span class="delimiter">'</span></span>), <span class="key">outlinecolor</span>: vec4(<span class="string"><span class="delimiter">'</span><span class="content">black</span><span class="delimiter">'</span></span>), <span class="key">pos</span>: vec3(l.x, -<span class="integer">11</span>,l.y)}
                                        thelabels.push(l2)
                                }
                        }
                        <span class="local-variable">this</span>.labels = thelabels
                        <span class="keyword">return</span> <span class="predefined-constant">true</span>
                }

                <span class="local-variable">this</span>.<span class="function">typeface</span> = <span class="keyword">function</span>() {
                        <span class="local-variable">this</span>.depth_test = <span class="string"><span class="delimiter">'</span><span class="content">src_depth &lt;= dst_depth</span><span class="delimiter">'</span></span>
                }
                <span class="comment">//this.depth_test = 'enabled'</span>

                <span class="local-variable">this</span>.position = <span class="string"><span class="delimiter">'</span><span class="content">absolute</span><span class="delimiter">'</span></span>
                <span class="local-variable">this</span>.bgcolor = <span class="predefined-constant">NaN</span>
                <span class="local-variable">this</span>.align = <span class="string"><span class="delimiter">'</span><span class="content">center</span><span class="delimiter">'</span></span>
                <span class="local-variable">this</span>.<span class="function">render</span> = <span class="keyword">function</span>() {}
        })

        <span class="comment">// view class of the roadtile</span>
        define.<span class="reserved">class</span>(<span class="local-variable">this</span>, <span class="string"><span class="delimiter">'</span><span class="content">roadtile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">$ui/view</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.is = tilebasemixin
                <span class="local-variable">this</span>.<span class="function">loadBufferFromTile</span> = <span class="keyword">function</span>(tile) {
                        <span class="keyword">if</span> (!<span class="local-variable">this</span>.shaders || !<span class="local-variable">this</span>.shaders.hardrect || !tile.roadVertexBuffer) <span class="keyword">return</span>
                        <span class="local-variable">this</span>.shaders.hardrect.mesh = tile.roadVertexBuffer
                        <span class="local-variable">this</span>.shaders.hardrect.mesh.sticky = <span class="predefined-constant">true</span>
                        <span class="keyword">return</span> <span class="predefined-constant">true</span>
                }

                <span class="local-variable">this</span>.<span class="function">hardrect</span> = <span class="keyword">function</span>() {
                        <span class="local-variable">this</span>.texture = require(<span class="string"><span class="delimiter">'</span><span class="content">./mapmaterial.png</span><span class="delimiter">'</span></span>)
                        <span class="local-variable">this</span>.<span class="function">position</span> = <span class="keyword">function</span>() {
                                <span class="keyword">var</span> sidevec = mesh.pos.zw
                                <span class="keyword">var</span> side = mesh.geom.x
                                <span class="keyword">var</span> dist = mesh.geom.y
                                <span class="keyword">var</span> linewidth = mesh.geom.z
                                <span class="keyword">var</span> possrc = mesh.pos.xy + sidevec * side * linewidth * <span class="float">0.5</span>
                                <span class="keyword">var</span> pos = vec2(<span class="integer">1</span>, -<span class="integer">1</span>) * possrc.xy;<span class="comment">// + (idxpos - view.tiletrans) * view.tilesize</span>

                                pos.xy -= ((((view.centerpos- view.centermeter)) / view.meterspertile) * <span class="float">1024.0</span>) * vec2(-<span class="float">1.0</span>, <span class="float">1.0</span>)
                                pos.xy /= pow(<span class="float">2.0</span>, view.layeroffset - view.fraczoom -<span class="integer">2</span>)
                                respos = vec4(pos.x, view.layeroffset * view.layerzmult + view.layerzoff, pos.y, <span class="integer">1</span>) * view.totalmatrix * view.viewmatrix
                                respos.w += mesh.pos.z * <span class="float">0.1</span>
                                <span class="keyword">return</span> respos
                        }

                        <span class="local-variable">this</span>.vertexstruct = BufferGen.RoadVertexStruct

                        <span class="local-variable">this</span>.mesh =  <span class="local-variable">this</span>.vertexstruct.array()

                        <span class="local-variable">this</span>.<span class="function">update</span> = <span class="keyword">function</span>() {
                                <span class="local-variable">this</span>.mesh =  <span class="local-variable">this</span>.vertexstruct.array()
                                <span class="comment">/* var a = TileSize / 4
                                var b = TileSize - a
                                this.mesh.push(a,a)
                                this.mesh.push(b,a)
                                this.mesh.push(b,b)
                                this.mesh.push(a,a)
                                this.mesh.push(b,b)
                                this.mesh.push(a,b); */</span>
                        }

                        <span class="local-variable">this</span>.drawtype = <span class="local-variable">this</span>.TRIANGLES
                        <span class="local-variable">this</span>.depth_test = <span class="string"><span class="delimiter">'</span><span class="content">disabled</span><span class="delimiter">'</span></span>

                        <span class="local-variable">this</span>.<span class="function">color</span> = <span class="keyword">function</span>() {
                                <span class="keyword">var</span> texcol = mesh.color;
                                <span class="keyword">var</span> prefog = texcol;
                                <span class="keyword">var</span> zdist = max(<span class="integer">0</span>.,min(<span class="integer">1</span>.,(respos.z-view.fogstart)/view.fogend))
                                zdist *= zdist
                                <span class="keyword">return</span> mix(prefog, view.fog, zdist)
                        }
                }

                <span class="local-variable">this</span>.hardrect = <span class="predefined-constant">true</span>
        })

        <span class="local-variable">this</span>.bgcolor = vec4(<span class="string"><span class="delimiter">'</span><span class="content">#c0c0d0</span><span class="delimiter">'</span></span>)
        <span class="local-variable">this</span>.flex = <span class="integer">1</span>
        <span class="local-variable">this</span>.clearcolor = <span class="string"><span class="delimiter">'</span><span class="content">black</span><span class="delimiter">'</span></span>
        <span class="local-variable">this</span>.framessincerender = <span class="integer">0</span>

        <span class="local-variable">this</span>.<span class="function">atDraw</span> = <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.framessincerender ++
        }

        <span class="comment">// update the map tiles</span>
        <span class="local-variable">this</span>.<span class="function">updateTiles</span> = <span class="keyword">function</span>() {
                <span class="keyword">if</span> (!<span class="local-variable">this</span>.dataset) <span class="keyword">return</span>
                <span class="keyword">if</span> (!<span class="local-variable">this</span>.dataset.centers) <span class="keyword">return</span>
                <span class="keyword">if</span> (!<span class="local-variable">this</span>.dataset.latlong) <span class="keyword">return</span>

                <span class="keyword">var</span> sourcezoom = <span class="local-variable">this</span>.dataset.zoomlevel
                <span class="local-variable">this</span>.zoomlevel = Math.ceil(sourcezoom)
                <span class="local-variable">this</span>.fraczoom = sourcezoom - <span class="local-variable">this</span>.zoomlevel
                <span class="local-variable">this</span>.meters_per_pixel = geo.metersPerPixel(<span class="local-variable">this</span>.zoomlevel)

                <span class="comment">// Center of viewport in meters, and tile</span>
                <span class="local-variable">this</span>.center_meters = geo.latLngToMeters(<span class="local-variable">this</span>.dataset.latlong[<span class="integer">0</span>], <span class="local-variable">this</span>.dataset.latlong[<span class="integer">1</span>])

                <span class="local-variable">this</span>.center_tile = []
                <span class="keyword">var</span> frac = []

                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="integer">0</span>; i &lt; <span class="integer">3</span>; i ++) {
                        frac.push(vec2(<span class="integer">0</span>, <span class="integer">0</span>))
                        <span class="local-variable">this</span>.center_tile.push(geo.tileForMeters(<span class="local-variable">this</span>.center_meters[<span class="integer">0</span>], <span class="local-variable">this</span>.center_meters[<span class="integer">1</span>], <span class="local-variable">this</span>.zoomlevel + i))
                }

                <span class="keyword">for</span> (<span class="keyword">var</span> a = <span class="integer">0</span>; a &lt; <span class="local-variable">this</span>.tilestoupdate.length; a ++) {
                        <span class="keyword">var</span> rt = <span class="local-variable">this</span>.tilestoupdate[a]
                        rt.meterspertile = geo.metersPerTile(<span class="local-variable">this</span>.zoomlevel + rt._layeroffset)
                        rt.setpos(<span class="local-variable">this</span>.center_tile[rt.layeroffset], <span class="local-variable">this</span>.zoomlevel + rt._layeroffset, frac[rt._layeroffset], <span class="local-variable">this</span>.fraczoom, <span class="local-variable">this</span>.center_meters)
                        rt.redraw()
                }
        }

        <span class="local-variable">this</span>.<span class="function">dumpdebug</span> = <span class="keyword">function</span>() {
                <span class="keyword">for</span> (<span class="keyword">var</span> a = <span class="integer">0</span>; a &lt; <span class="local-variable">this</span>.tilestoupdate.length; a ++) {
                        <span class="keyword">var</span> rt = <span class="local-variable">this</span>.tilestoupdate[a]
                        console.log(rt.lastpos)
                }
        }

        <span class="local-variable">this</span>.<span class="function">layout</span> = <span class="keyword">function</span>(){
                <span class="local-variable">this</span>.dotwice = <span class="integer">0</span>
                <span class="keyword">if</span> (<span class="local-variable">this</span>.rerender) <span class="local-variable">this</span>.rerender()
        }

        <span class="local-variable">this</span>.<span class="function">render</span> = <span class="keyword">function</span>() {
                <span class="keyword">var</span> layout = <span class="local-variable">this</span>._layout
                <span class="local-variable">this</span>.tilestoupdate = []

                <span class="keyword">var</span> res = [<span class="local-variable">this</span>.dataset]
                <span class="keyword">var</span> res3d = []
                <span class="keyword">var</span> buildings3d = []
                <span class="keyword">var</span> labels3d = []
                <span class="keyword">var</span> poi3d = []
                <span class="keyword">var</span> div = <span class="integer">512</span>
                <span class="local-variable">this</span>.tilewidth = Math.ceil(layout.width / div)
                <span class="local-variable">this</span>.tileheight = Math.ceil(layout.height / div)

                <span class="local-variable">this</span>.camdist = <span class="integer">20000</span>;

                <span class="keyword">var</span> aspect = layout.width / layout.height
                <span class="keyword">var</span> fov = (Math.atan(((layout.width / <span class="integer">2</span>) * <span class="integer">40</span>) / <span class="local-variable">this</span>.camdist) * <span class="integer">360</span> / <span class="float">6.283</span>) / aspect

                <span class="keyword">var</span> basew = <span class="local-variable">this</span>.tilewidth / <span class="integer">2</span>
                <span class="keyword">var</span> baseh = <span class="local-variable">this</span>.tileheight / <span class="integer">2</span>
                <span class="keyword">var</span> showland = <span class="predefined-constant">true</span>

                <span class="keyword">for</span> (<span class="keyword">var</span> layer = <span class="integer">0</span>; layer &lt; <span class="integer">2</span>; layer ++) {
                        <span class="local-variable">this</span>.tilewidth = <span class="integer">0</span>;
                        <span class="local-variable">this</span>.tileheight = <span class="integer">0</span>;
                        <span class="keyword">var</span> tilearea = vec2(<span class="local-variable">this</span>.tilewidth, <span class="local-variable">this</span>.tileheight)
                        <span class="keyword">var</span> ltx = <span class="integer">0</span>
                        <span class="keyword">var</span> lty = <span class="integer">0</span>
                        <span class="keyword">var</span> extw = basew * Math.pow(<span class="float">2.0</span>, layer - <span class="float">0.5</span>)
                        <span class="keyword">var</span> exth = baseh * Math.pow(<span class="float">2.0</span>, layer - <span class="float">0.5</span>)
                        xs = -extw
                        xe = -xs + <span class="integer">1</span>
                        ys = -exth
                        ye = -ys + <span class="integer">1</span>
                        <span class="keyword">if</span> (showland) {
                                <span class="keyword">for</span> (<span class="keyword">var</span> x = xs; x &lt; xe; x ++) {
                                        <span class="keyword">for</span> (<span class="keyword">var</span> y = ys; y &lt; ye; y ++) {
                                                <span class="keyword">var</span> land = <span class="local-variable">this</span>.landtile({<span class="key">host</span>: <span class="local-variable">this</span>, <span class="key">mapdata</span>: <span class="local-variable">this</span>.dataset, <span class="key">fog</span>: <span class="local-variable">this</span>.bgcolor, <span class="key">tilearea</span>: tilearea, <span class="key">trans</span>: vec2(x,y), <span class="key">layeroffset</span>: layer})
                                                <span class="local-variable">this</span>.tilestoupdate.push(land)
                                                res3d.push(land)
                                        }
                                }
                        }

                        <span class="keyword">for</span> (<span class="keyword">var</span> x = xs; x &lt; xe; x ++) {
                                <span class="keyword">for</span> (<span class="keyword">var</span> y = ys; y &lt; ye; y ++) {
                                        <span class="keyword">var</span> road = <span class="local-variable">this</span>.roadtile({<span class="key">host</span>: <span class="local-variable">this</span>, <span class="key">mapdata</span>: <span class="local-variable">this</span>.dataset, <span class="key">fog</span>: <span class="local-variable">this</span>.bgcolor, <span class="key">tilearea</span>: tilearea, <span class="key">trans</span>: vec2(x,y), <span class="key">layeroffset</span>: layer})
                                        <span class="local-variable">this</span>.tilestoupdate.push(road)
                                        res3d.push(road)
                                }
                        }

                        <span class="keyword">for</span> (<span class="keyword">var</span> x = xs; x &lt; xe; x ++) {
                                <span class="keyword">for</span> (<span class="keyword">var</span> y = ys; y &lt; ye; y ++) {
                                        <span class="keyword">var</span> building = <span class="local-variable">this</span>.buildingtile({<span class="key">host</span>: <span class="local-variable">this</span>, <span class="key">mapdata</span>: <span class="local-variable">this</span>.dataset, <span class="key">fog</span>: <span class="local-variable">this</span>.bgcolor, <span class="key">tilearea</span>: tilearea, <span class="key">trans</span>: vec2(x,y), <span class="key">layeroffset</span>: layer})
                                        <span class="local-variable">this</span>.tilestoupdate.push(building)
                                        buildings3d.push(building)
                                }
                        }

                        <span class="keyword">if</span> (layer == <span class="integer">1</span> &amp;&amp; <span class="local-variable">this</span>.showlabels) {
                                <span class="keyword">for</span> (<span class="keyword">var</span> x = xs; x &lt; xe; x ++) {
                                        <span class="keyword">for</span> (<span class="keyword">var</span> y = ys; y &lt; ye; y ++) {
                                                <span class="keyword">var</span> labels = <span class="local-variable">this</span>.labeltile({<span class="key">host</span>: <span class="local-variable">this</span>, <span class="key">mapdata</span>: <span class="local-variable">this</span>.dataset, <span class="key">fog</span>: <span class="local-variable">this</span>.bgcolor, <span class="key">tilearea</span>: tilearea, <span class="key">trans</span>: vec2(x,y), <span class="key">layeroffset</span>: layer})
                                                <span class="local-variable">this</span>.tilestoupdate.push(labels)
                                                labels3d.push(labels)
                                        }
                                }
                        }
                }

                <span class="keyword">var</span> zoom = <span class="float">0.25</span>

                res.push(
                        view({
                                <span class="key">bgcolor</span>: <span class="string"><span class="delimiter">'</span><span class="content">red</span><span class="delimiter">'</span></span>,
                                <span class="key">flex</span>: <span class="integer">1</span>,
                                <span class="key">viewport</span>: <span class="string"><span class="delimiter">'</span><span class="content">3d</span><span class="delimiter">'</span></span>,
                                <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">mapinside</span><span class="delimiter">'</span></span>,
                                <span class="key">nearplane</span>: <span class="integer">100</span> ,
                                <span class="key">fov</span>: fov,
                                <span class="key">farplane</span>: <span class="local-variable">this</span>.camdist * <span class="integer">2</span>,
                                <span class="key">camera</span>: vec3(<span class="integer">0</span>, -<span class="local-variable">this</span>.camdist * zoom * <span class="float">0.13</span>, <span class="local-variable">this</span>.camdist * zoom * <span class="float">0.3</span>),
                                <span class="key">fov</span>: fov,
                                <span class="key">up</span>: vec3(<span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>),
                                <span class="key">lookat</span>: vec3(<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>)
                        },[
                                view({
                                        <span class="key">bgcolor</span>: <span class="predefined-constant">NaN</span>
                                },[
                                        res3d,
                                        buildings3d,
                                        labels3d,
                                        <span class="local-variable">this</span>.constructor_children
                                ])
                        ])
                )
                <span class="comment">//res.push(this.constructor_children)</span>
                <span class="keyword">var</span> camdist = <span class="local-variable">this</span>.camdist
                res.push(button({
                        <span class="key">position</span>: <span class="string"><span class="delimiter">'</span><span class="content">absolute</span><span class="delimiter">'</span></span>,
                        <span class="key">top</span>: <span class="integer">20</span>,
                        <span class="key">label</span>: <span class="string"><span class="delimiter">'</span><span class="content">2D/3D</span><span class="delimiter">'</span></span>,
                        <span class="key">mode</span>: <span class="integer">1</span>,
                        <span class="function">click</span>: <span class="keyword">function</span>() {
                                <span class="keyword">var</span> map = <span class="local-variable">this</span>.find(<span class="string"><span class="delimiter">'</span><span class="content">mapinside</span><span class="delimiter">'</span></span>)
                                <span class="keyword">if</span> (<span class="local-variable">this</span>.mode == <span class="integer">1</span>) {
                                        <span class="local-variable">this</span>.mode = <span class="integer">2</span>
                                        map.camera = Animate({<span class="integer">1</span>: vec3(<span class="integer">0</span>, -<span class="integer">4650</span>, <span class="integer">150</span>)})
                                }
                                <span class="keyword">else</span> {
                                        <span class="local-variable">this</span>.mode = <span class="integer">1</span>
                                        map.camera = Animate({<span class="integer">1</span>: vec3(<span class="integer">0</span>, -camdist * zoom * <span class="float">0.13</span>,camdist * zoom * <span class="float">0.3</span>)})
                                }

                        }
                }))
                res.push(label({
                        <span class="key">bottom</span>: <span class="integer">10</span>,
                        <span class="key">fontsize</span>: <span class="integer">8</span>,
                        <span class="key">position</span>: <span class="string"><span class="delimiter">'</span><span class="content">absolute</span><span class="delimiter">'</span></span>,
                        <span class="key">fgcolor</span>: <span class="string"><span class="delimiter">'</span><span class="content">black</span><span class="delimiter">'</span></span>,
                        <span class="key">text</span>: <span class="string"><span class="delimiter">'</span><span class="content">Vector data copyright OpenStreetMap contributors, Whos On First. Webservice by mapzen.</span><span class="delimiter">'</span></span>,
                        <span class="key">font</span>: ubuntufont
                }))
                <span class="local-variable">this</span>.framessincerender = <span class="integer">0</span>

                <span class="keyword">if</span>(!<span class="local-variable">this</span>.dotwice &amp;&amp; <span class="local-variable">this</span>.rerender) <span class="local-variable">this</span>.dotwice++, <span class="local-variable">this</span>.rerender()

                <span class="keyword">return</span> res
        }

        <span class="local-variable">this</span>.<span class="function">atChildrenRendered</span> = <span class="keyword">function</span>() {
                <span class="local-variable">this</span>.updateTiles()
                <span class="local-variable">this</span>.redraw()
        }

})
</pre></td>
</tr></table>

</body>
</html>
